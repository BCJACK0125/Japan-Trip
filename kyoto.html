已開啟會話群組。共 7 封郵件。4 封未讀取郵件。

移至內容
透過螢幕閱讀器使用 Gmail
第 1 個，共 1,140 個
Test Email with CSV Attachment
收件匣

CrawlerReport@dev
附件
上午11:39 (9 小時前)
Hello! Please find the attached CSV report.

CrawlerReport@dev
附件
下午3:09 (5 小時前)
Hello! Please find the attached CSV report.

CrawlerReport@dev
附件
下午3:10 (5 小時前)
Hello! Please find the attached CSV report.

CrawlerReport@dev <noreply-dev@esb13.cloud>
附件
下午3:35 (5 小時前)
寄給 我

這封郵件似乎是以英文撰寫而成
 1 個附件
  •  已通過 Gmail 掃描檢查

CrawlerReport@dev <noreply-dev@esb13.cloud>
附件
下午4:03 (4 小時前)
寄給 我

這封郵件似乎是以英文撰寫而成
 1 個附件
  •  已通過 Gmail 掃描檢查

CrawlerReport@dev <noreply-dev@esb13.cloud>
附件
下午4:36 (4 小時前)
寄給 我

這封郵件似乎是以英文撰寫而成
 1 個附件
  •  已通過 Gmail 掃描檢查

CrawlerReport@dev <noreply-dev@esb13.cloud>
附件
下午4:45 (3 小時前)
寄給 我

這封郵件似乎是以英文撰寫而成
 1 個附件
  •  已通過 Gmail 掃描檢查
<!doctype html>
<html lang="zh-Hant">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="theme-color" content="#2F4F4F" />
		<title>2026 京阪神行程小工具</title>
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap"
			rel="stylesheet"
		/>
		<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
		<style>
			:root {
				--ink: #2f4f4f;
				--bg: #f5f5f5;
				--card: #ffffff;
				--accent: #ff6b6b;
				--muted: rgba(47, 79, 79, 0.64);
				--line: rgba(47, 79, 79, 0.14);
				--shadow: 0 10px 28px rgba(47, 79, 79, 0.12);
				--radius: 16px;
			}

			* {
				box-sizing: border-box;
			}

			html,
			body {
				height: 100%;
			}

			body {
				margin: 0;
				font-family: Inter, "Noto Sans JP", system-ui, -apple-system, "SF Pro Text",
					"Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang TC", "Noto Sans TC",
					sans-serif;
				color: var(--ink);
				background: var(--bg);
				-webkit-font-smoothing: antialiased;
				text-rendering: optimizeLegibility;
			}

			/* Very subtle checkered (市松) accent */
			.app {
				min-height: 100%;
				padding-bottom: 84px;
				background-image:
					linear-gradient(45deg, rgba(47, 79, 79, 0.03) 25%, transparent 25%),
					linear-gradient(-45deg, rgba(47, 79, 79, 0.03) 25%, transparent 25%),
					linear-gradient(45deg, transparent 75%, rgba(47, 79, 79, 0.03) 75%),
					linear-gradient(-45deg, transparent 75%, rgba(47, 79, 79, 0.03) 75%);
				background-size: 32px 32px;
				background-position: 0 0, 0 16px, 16px -16px, -16px 0;
			}

			.topbar {
				position: sticky;
				top: 0;
				z-index: 5;
				background: rgba(245, 245, 245, 0.88);
				backdrop-filter: blur(10px);
				border-bottom: 1px solid var(--line);
			}

			.topbar-inner {
				max-width: 560px;
				margin: 0 auto;
				padding: 14px 16px 10px;
			}

			.title {
				display: flex;
				align-items: baseline;
				justify-content: space-between;
				gap: 12px;
			}

			.title h1 {
				margin: 0;
				font-size: 18px;
				letter-spacing: 0.2px;
			}

			.subtitle {
				margin: 4px 0 0;
				font-size: 12px;
				color: var(--muted);
			}

			main {
				max-width: 560px;
				margin: 0 auto;
				padding: 16px;
			}

			.page {
				display: none;
			}

			.page[aria-hidden="false"] {
				display: block;
			}

			.day {
				margin: 14px 0 20px;
			}

			.day-header {
				background: var(--card);
				border: 1px solid var(--line);
				border-radius: var(--radius);
				box-shadow: var(--shadow);
				padding: 12px 12px;
				display: grid;
				gap: 10px;
			}

			.day-title {
				display: flex;
				align-items: flex-start;
				justify-content: space-between;
				gap: 12px;
			}

			.day-title .left {
				display: grid;
				gap: 4px;
			}

			.day-title .date {
				font-size: 15px;
				font-weight: 700;
			}

			.day-title .meta {
				font-size: 12px;
				color: var(--muted);
			}

			.weather {
				display: flex;
				align-items: center;
				justify-content: flex-end;
				gap: 10px;
			}

			.wx-icon {
				width: 34px;
				height: 34px;
				display: grid;
				place-items: center;
				border-radius: 10px;
				background: rgba(47, 79, 79, 0.06);
				border: 1px solid rgba(47, 79, 79, 0.08);
				font-size: 18px;
			}

			.wx-text {
				display: grid;
				gap: 2px;
				text-align: right;
			}

			.wx-text .t {
				font-weight: 700;
				font-size: 12px;
			}

			.wx-text .d {
				font-size: 12px;
				color: var(--muted);
			}

			.wx-source {
				font-size: 11px;
				color: rgba(47, 79, 79, 0.55);
			}

			.items {
				margin-top: 12px;
				display: grid;
				gap: 10px;
			}

			.card {
				background: var(--card);
				border: 1px solid var(--line);
				border-radius: var(--radius);
				box-shadow: var(--shadow);
				overflow: hidden;
			}

			.card[draggable="true"] {
				cursor: grab;
			}

			.card.dragging {
				opacity: 0.65;
			}

			.card-top {
				display: flex;
				align-items: center;
				justify-content: space-between;
				gap: 12px;
				padding: 12px;
			}

			.tag {
				display: inline-flex;
				align-items: center;
				gap: 6px;
				padding: 6px 10px;
				border-radius: 999px;
				font-size: 12px;
				font-weight: 700;
				line-height: 1;
				border: 1px solid rgba(0, 0, 0, 0.06);
			}

			.tag.sight {
				background: rgba(32, 178, 170, 0.16);
				color: #0b5c58;
			}
			.tag.food {
				background: rgba(255, 149, 0, 0.18);
				color: #8a4f00;
			}
			.tag.transit {
				background: rgba(99, 102, 241, 0.12);
				color: #3f4d7a;
			}
			.tag.stay {
				background: rgba(47, 79, 79, 0.12);
				color: var(--ink);
			}
			.tag.shop {
				background: rgba(255, 107, 107, 0.14);
				color: #7a2b2b;
			}
			.tag.other {
				background: rgba(47, 79, 79, 0.08);
				color: var(--ink);
			}

			.time {
				font-size: 12px;
				color: var(--muted);
				font-weight: 600;
			}

			.card-body {
				padding: 0 12px 12px;
				display: grid;
				gap: 8px;
			}

			.note-input {
				width: 100%;
				min-height: 92px;
				resize: vertical;
				padding: 10px 10px;
				border-radius: 12px;
				border: 1px solid rgba(47, 79, 79, 0.18);
				background: #fff;
				font-size: 13px;
				line-height: 1.45;
				color: var(--ink);
			}

			.note-input:focus {
				outline: none;
				border-color: rgba(47, 79, 79, 0.34);
			}

			.name {
				font-size: 15px;
				font-weight: 800;
				letter-spacing: 0.1px;
			}

			.row {
				display: grid;
				grid-template-columns: 72px 1fr;
				gap: 10px;
				font-size: 13px;
				line-height: 1.35;
			}

			.row .k {
				color: rgba(47, 79, 79, 0.6);
				font-weight: 700;
			}

			.row .v {
				color: var(--ink);
			}

			.guide {
				display: flex;
				flex-wrap: wrap;
				gap: 8px;
				margin-top: 2px;
			}

			.pill {
				display: inline-flex;
				align-items: center;
				padding: 6px 10px;
				border-radius: 999px;
				font-size: 12px;
				font-weight: 800;
				border: 1px solid rgba(0, 0, 0, 0.06);
			}
			.pill.must-eat {
				background: rgba(255, 59, 48, 0.14);
				color: #7a1b17;
			}
			.pill.must-order {
				background: rgba(255, 149, 0, 0.18);
				color: #8a4f00;
			}
			.pill.must-buy {
				background: rgba(175, 82, 222, 0.16);
				color: #4c1c66;
			}
			.pill.reserve {
				background: rgba(10, 132, 255, 0.16);
				color: #063a74;
			}

			details.story {
				border-top: 1px dashed rgba(47, 79, 79, 0.24);
				padding-top: 8px;
			}

			details.story > summary {
				cursor: pointer;
				user-select: none;
				font-size: 13px;
				font-weight: 800;
				color: var(--ink);
				list-style: none;
			}

			details.story > summary::-webkit-details-marker {
				display: none;
			}

			details.story > summary .hint {
				font-size: 12px;
				font-weight: 700;
				color: rgba(47, 79, 79, 0.6);
				margin-left: 8px;
			}

			details.story p {
				margin: 8px 0 0;
				font-size: 13px;
				color: rgba(47, 79, 79, 0.78);
				line-height: 1.45;
			}

			.actions {
				display: flex;
				gap: 10px;
				align-items: center;
				justify-content: flex-end;
				margin-top: 4px;
			}

			.btn {
				appearance: none;
				border: 1px solid rgba(47, 79, 79, 0.18);
				background: rgba(47, 79, 79, 0.06);
				color: var(--ink);
				border-radius: 12px;
				padding: 10px 12px;
				min-height: 44px;
				font-weight: 800;
				font-size: 13px;
				text-decoration: none;
				display: inline-flex;
				align-items: center;
				justify-content: center;
				gap: 8px;
			}

			.btn.primary {
				background: var(--accent);
				color: #fff;
				border-color: rgba(0, 0, 0, 0.06);
			}

			.btn:active {
				transform: translateY(1px);
			}

			.tool-grid {
				display: grid;
				gap: 12px;
			}

			.section-title {
				font-size: 14px;
				font-weight: 900;
				margin: 0 0 8px;
			}

			.tool-card {
				background: var(--card);
				border: 1px solid var(--line);
				border-radius: var(--radius);
				box-shadow: var(--shadow);
				padding: 12px;
			}

			.hotel-box {
				border: 1px solid var(--line);
				border-radius: 16px;
				padding: 12px;
				margin-top: 10px;
			}

			.hotel-box .hotel-name {
				font-size: 14px;
				font-weight: 950;
				margin: 0;
			}

			.hotel-box .hotel-stay {
				margin-top: 4px;
				font-size: 12px;
				color: var(--muted);
				font-weight: 800;
			}

			.hotel-fields {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 10px;
				margin-top: 10px;
			}

			.tool-card .small {
				font-size: 12px;
				color: var(--muted);
				margin-top: 6px;
				line-height: 1.45;
			}

			.kv {
				display: grid;
				gap: 8px;
				margin-top: 10px;
			}

			.kv .line {
				display: grid;
				grid-template-columns: 92px 1fr;
				gap: 10px;
				font-size: 13px;
				line-height: 1.35;
			}

			.kv .line .k {
				color: rgba(47, 79, 79, 0.6);
				font-weight: 800;
			}

			.kv .line .v {
				font-weight: 650;
			}

			.ledger {
				display: grid;
				gap: 12px;
				margin-top: 10px;
			}

			.ledger form {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 10px;
			}

			.ledger form .full {
				grid-column: 1 / -1;
			}

			label {
				display: grid;
				gap: 6px;
				font-size: 12px;
				font-weight: 800;
				color: rgba(47, 79, 79, 0.72);
			}

			input,
			select {
				width: 100%;
				min-height: 44px;
				border-radius: 12px;
				border: 1px solid rgba(47, 79, 79, 0.18);
				background: #fff;
				padding: 10px 12px;
				font-size: 14px;
				color: var(--ink);
				outline: none;
			}

			input:focus,
			select:focus {
				border-color: rgba(47, 79, 79, 0.4);
				box-shadow: 0 0 0 3px rgba(47, 79, 79, 0.12);
			}

			.table {
				width: 100%;
				border-collapse: collapse;
				overflow: hidden;
				border-radius: 12px;
				border: 1px solid var(--line);
			}

			.table th,
			.table td {
				padding: 10px 10px;
				border-bottom: 1px solid rgba(47, 79, 79, 0.12);
				font-size: 13px;
				text-align: left;
				vertical-align: top;
			}

			.table th {
				background: rgba(47, 79, 79, 0.06);
				font-weight: 900;
			}

			.table tr:last-child td {
				border-bottom: none;
			}

			.table .right {
				text-align: right;
			}

			.danger {
				background: rgba(255, 59, 48, 0.10);
				border-color: rgba(255, 59, 48, 0.18);
				color: #7a1b17;
			}

			.tabs {
				position: fixed;
				bottom: 0;
				left: 0;
				right: 0;
				z-index: 10;
				background: rgba(245, 245, 245, 0.92);
				backdrop-filter: blur(12px);
				border-top: 1px solid var(--line);
			}

			.tabs-inner {
				max-width: 560px;
				margin: 0 auto;
				padding: 10px 12px;
				display: grid;
				grid-template-columns: repeat(4, minmax(0, 1fr));
				gap: 10px;
			}

			.tab {
				min-height: 50px;
				border-radius: 14px;
				border: 1px solid rgba(47, 79, 79, 0.18);
				background: #fff;
				font-weight: 900;
				display: inline-flex;
				align-items: center;
				justify-content: center;
				gap: 10px;
			}

			.tab[aria-selected="true"] {
				background: rgba(47, 79, 79, 0.08);
				border-color: rgba(47, 79, 79, 0.30);
			}

			.hint-note {
				font-size: 12px;
				color: rgba(47, 79, 79, 0.62);
				line-height: 1.45;
				margin: 10px 2px 0;
			}

			.day-tabs {
				position: sticky;
				top: 64px;
				z-index: 4;
				margin: 0 -16px 12px;
				padding: 10px 16px;
				overflow-x: auto;
				display: flex;
				gap: 10px;
				scrollbar-width: none;
				background: rgba(245, 245, 245, 0.92);
				backdrop-filter: blur(10px);
				border-bottom: 1px solid rgba(47, 79, 79, 0.10);
			}

			.day-tabs::-webkit-scrollbar {
				display: none;
			}

			.day-tab {
				flex: 0 0 auto;
				min-height: 44px;
				padding: 10px 12px;
				border-radius: 999px;
				border: 1px solid rgba(47, 79, 79, 0.18);
				background: #fff;
				color: var(--ink);
				font-weight: 900;
				font-size: 13px;
				white-space: nowrap;
			}

			.day-tab[aria-selected="true"] {
				background: rgba(47, 79, 79, 0.10);
				border-color: rgba(47, 79, 79, 0.34);
			}

			.day-tab:active {
				transform: translateY(1px);
			}

			@media (max-width: 360px) {
				.row {
					grid-template-columns: 64px 1fr;
				}
				.kv .line {
					grid-template-columns: 86px 1fr;
				}
			}

			/* === Map (Leaflet) === */
			.map-shell {
				position: relative;
				height: 420px;
				margin: 0 -16px;
				border-top: 1px solid rgba(47, 79, 79, 0.08);
				border-bottom: 1px solid rgba(47, 79, 79, 0.08);
				background: rgba(47, 79, 79, 0.06);
			}

			@supports (height: 100dvh) {
				.map-shell {
					height: 420px;
				}
			}

			.map {
				width: 100%;
				height: 100%;
			}

			.map-loading {
				position: absolute;
				inset: 0;
				z-index: 2;
				background: rgba(245, 245, 245, 0.78);
				backdrop-filter: blur(8px);
				display: none;
				align-items: center;
				justify-content: center;
				gap: 10px;
				font-weight: 900;
			}

			.map-loading[aria-hidden="false"] {
				display: flex;
			}

			.map-controls {
				position: absolute;
				left: 12px;
				right: 12px;
				bottom: 12px;
				z-index: 3;
				padding: 10px;
				display: flex;
				align-items: center;
				justify-content: space-between;
				gap: 12px;
				border-radius: 14px;
				border: 1px solid rgba(47, 79, 79, 0.14);
				background: rgba(255, 255, 255, 0.90);
				backdrop-filter: blur(10px);
				box-shadow: var(--shadow);
			}

			.map-controls .meta {
				display: grid;
				gap: 2px;
				min-width: 0;
			}

			.map-controls .meta .t {
				font-size: 13px;
				font-weight: 950;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}

			.map-controls .meta .d {
				font-size: 12px;
				color: var(--muted);
			}

			.map-controls .btns {
				display: flex;
				gap: 8px;
				flex: 0 0 auto;
			}

			.map-controls .btn {
				min-height: 40px;
				padding: 9px 10px;
				border-radius: 12px;
			}

			.gps-pulse {
				width: 14px;
				height: 14px;
				border: 2px solid #fff;
				border-radius: 50%;
				background-color: var(--ink);
				box-shadow: 0 0 0 4px rgba(47, 79, 79, 0.24);
				animation: pulse-ink 2s infinite;
			}

			@keyframes pulse-ink {
				0% {
					box-shadow: 0 0 0 0 rgba(47, 79, 79, 0.34);
				}
				70% {
					box-shadow: 0 0 0 10px rgba(47, 79, 79, 0);
				}
				100% {
					box-shadow: 0 0 0 0 rgba(47, 79, 79, 0);
				}
			}

			.leaflet-popup-content-wrapper {
				border-radius: 14px;
			}
		</style>
	</head>
	<body>
		<div class="app" id="app">
			<header class="topbar">
				<div class="topbar-inner">
					<div class="title">
						<h1>🌸 2026 京阪神行程小工具</h1>
						<div class="wx-source" id="nowHint"></div>
					</div>
					<p class="subtitle">手機優先｜一頁搞定每日行程＋吃吃喝喝＋旅行工具箱</p>
				</div>
			</header>

			<main>
				<section class="page" id="page-daily" aria-hidden="false">
					<div class="day-tabs" id="dayTabs" role="tablist" aria-label="每日分頁"></div>
					<div id="dailyRoot"></div>
					<div class="hint-note">
						天氣模組預設為「示意資料」。要啟用即時天氣：請在程式碼中填入 `WEATHERAPI_KEY`。
					</div>
				</section>

				<section class="page" id="page-map" aria-hidden="true">
					<div class="map-shell" id="mapShell">
						<div id="map" class="map" aria-label="地圖"></div>
						<div class="map-loading" id="mapLoading" aria-hidden="true">⏳ 讀取地圖中…</div>
						<div class="map-controls" role="group" aria-label="地圖控制">
							<div class="meta">
								<div class="t" id="mapTitle">📍 地圖</div>
								<div class="d" id="mapCounts">—</div>
							</div>
							<div class="btns">
								<button class="btn" id="mapRefresh" type="button">🔄</button>
								<button class="btn" id="mapLocate" type="button">🎯</button>
								<button class="btn primary" id="mapToggleFood" type="button">＋今日餐廳</button>
							</div>
						</div>
					</div>
					<div class="hint-note">
						提示：地圖會顯示「當天行程地點」，並可一鍵疊加顯示「該城市已收藏的餐廳」。
					</div>
				</section>

				<section class="page" id="page-food" aria-hidden="true">
					<div class="day-tabs" id="foodPlaceTabs" role="tablist" aria-label="吃吃喝喝地點"></div>
					<div id="foodRoot"></div>
				</section>

				<section class="page" id="page-tools" aria-hidden="true">
					<div class="tool-grid" id="toolsRoot"></div>
				</section>
			</main>

			<nav class="tabs" aria-label="主要導覽">
				<div class="tabs-inner">
					<button class="tab" id="tab-daily" aria-selected="true" type="button">
						🗓️ 每日行程
					</button>
					<button class="tab" id="tab-map" aria-selected="false" type="button">
						🗺️ 地圖
					</button>
					<button class="tab" id="tab-food" aria-selected="false" type="button">
						🍴 吃吃喝喝
					</button>
					<button class="tab" id="tab-tools" aria-selected="false" type="button">
						🧰 旅行工具箱
					</button>
				</div>
			</nav>
		</div>

		<script>
			/**
			 * 資料輸入（結構化文字）：
			 * - 你可以直接把新的 CSV 文字貼到 `ITINERARY_CSV`，系統會自動解析與渲染。
			 */
			const ITINERARY_CSV = `日期,時間,類型,名稱,詳細資訊,地址/地點,費用,備註/攻略
4/16,19:20,抵達,關西機場 (KIX),航班 D7378 落地,大阪府泉佐野市泉州空港北,-,提前填妥 Visit Japan Web 掃碼入境
4/16,20:44,交通,JR Haruka,關西機場直達京都車站,JR 關西機場站 4 號月台,"💰 2,420円",【預約】Klook 購票，綠色機台兌換實體票
4/16,22:30,住宿,CheckIn Hotel 四條烏丸,辦理入住手續,京都市中京区手洗水町654-2,-,21 號出口步行 2 分鐘，1F 有 Lawson
4/17,07:30,景點,伏見稻荷大社,避開人潮，獨享千本鳥居,京都市伏見区深草藪之内町68,🆓 免費,【必看】狐狸繪馬，建議清晨抵達可拍空景
4/17,10:00,景點,清水寺,巡遊清水舞台與地主神社,京都市東山区清水1-294,💰 500円,【必看】本堂舞台、音羽之瀧祈福
4/17,12:00,購物,二年坂/三年坂,充滿古都風味的散策小路,京都市東山区清水,-,【必看】宮崎駿商店、特色星巴克
4/17,14:00,購物,錦市場,京都人的廚房，各類海鮮小吃,京都市中京区西大文字町609,"💰 2,000円",【必吃】豆乳甜甜圈，18:00 前會收攤
4/17,16:30,景點,下鴨神社,世界遺產，守護女性的神社,京都市左京区下鴨泉川町59,🆓 免費,【必買】超唯美「蕾絲御守」與「水守」
4/17,19:30,餐廳,滿天串燒 (先斗町),鴨川旁極具氣氛的串燒店,京都市中京区若松町140-1,"💰 4,000円",【必點】雞肉丸串、雞皮串，建議預約
4/18,08:00,交通,JR 山陰本線,搭往馬堀站轉小火車,JR 京都車站或二條站,💰 330円,從飯店出發建議搭東西線至二條站轉 JR
4/18,09:02,景點,嵐山小火車,龜岡站發車前往嵐山站,龜岡觀光車站,💰 880円,【預約】官網提前訂票，推薦雙數座
4/18,10:30,景點,御髮神社,全日唯一頭髮守護神,京都市右京区嵯峨小倉山田淵山町10,🆓 免費,【必看】剪下一撮頭髮放入「髮塚」祈福
4/18,11:30,景點,竹林小徑,聽風吹過竹林的靜謐感,京都市右京区嵯峨小倉山,🆓 免費,【必看】嵐山代表性景觀，電影取景地
4/18,13:00,餐廳,嵐山商業街,在地小吃與 Miffy 麵包,京都市右京区嵯峨天龍寺造路町,"💰 2,000円",【必買】Miffy 嵐山限定款紅豆麵包
4/19,08:30,景點,宇治平等院,硬幣上的千年鳳凰堂,宇治市宇治蓮華116,💰 700円,【必看】鳳凰堂反映在池水上的倒影
4/19,11:30,餐廳,中村藤吉 本店,宇治抹茶甜點天花板,宇治市宇治壱番10,"💰 3,000円",【必點】竹筒抹茶冰淇淋，需現場抽號碼牌
4/19,14:30,景點,奈良公園,與親人(貪吃)的鹿互動,奈良市雑司町,💰 200円,【必吃】鹿仙貝，小心別被鹿群包圍
4/19,16:30,景點,若草山,登上山坡眺望奈良全景,奈良市雑司町,💰 150円,【必看】夕陽極美，需在 17:00 前入場
4/19,20:00,住宿,ZONE 心齋橋西區,抵達大阪飯店 Check-in,大阪市西区立売堀1-10-2,-,本町站/心齋橋站步行可達
4/20,08:30,交通,御堂筋線+公車,前往勝尾寺最快路徑,箕面萱野站 8 號站台,💰 660円,2026 新地標箕面萱野站轉 30 號巴士
4/20,10:45,景點,勝尾寺,滿坑滿谷的祈福不倒翁,箕面市粟生間谷2914-1,💰 500円,【必吃】達摩造型便當，【必買】不倒翁御守
4/20,14:00,景點,箕面大瀑布,負離子滿滿的森林散步,箕面市箕面公園,🆓 免費,【必吃】炸楓葉，口感酥脆微甜
4/20,18:00,購物,心齋橋/道頓堀,大阪地標與藥妝採買,大阪市中央区心齋橋筋,-,【必看】跑跑人固力果霓虹燈
4/21,09:00,景點,大阪城天守閣,大阪象徵，宏偉壯觀,大阪市中央区大阪城1-1,💰 600円,【必看】登上頂樓俯瞰大阪市區景觀
4/21,12:00,餐廳,黑門市場,高品質海鮮、神戶牛,大阪市中央区日本橋2-4-1,"💰 4,000円",【必吃】現開生蠔、丸善食肉店神戶牛
4/21,15:00,景點,難波八阪神社,威風凜凜的巨大獅子殿,大阪市浪速区元町2-9-19,🆓 免費,【必看】獅子頭大殿，象徵吸走厄運
4/21,18:00,景點,梅田空中庭園,未來感建築與高空夜景,大阪市北区大淀中1-1-88,"💰 1,500円",【必看】露天圓形展望台，情侶約會聖地
4/22,10:00,購物,難波 Parco/大丸,最後行李塞滿機會,大阪市中央区心齋橋筋1-7-1,-,【必吃】Shake Shack 漢堡
4/22,15:00,購物,臨空城 Outlet,機場前最後一站大掃貨,泉佐野市りんくう往來南3-28,-,【必買】運動品牌、精品折扣極大
4/22,18:30,交通,南海電鐵,臨空城至關西機場,南海電鐵臨空城站,💰 370円,僅需 6 分鐘即可抵達 T1 航廈
4/22,20:55,起飛,關西機場 (KIX),航班 D7379 起飛回台,大阪府泉佐野市泉州空港北,-,建議提前 3 小時抵達辦理登機`;

			const FOOD_CSV = `標題,筆記,網址,標籤,留言
,,,🏨 家;🤘 吃飯飯;🎃 景點,
Kiyasu Sohonpo,,https://www.google.com/maps/place/Kiyasu+Sohonpo/data=!4m2!3m1!1s0x6000e5ce1ef2f257:0x75f0a2e2b26b1e7e,🤘 吃飯飯,
吟釀拉麵 久保田,"❗️貼心提醒：這家店需要先進門在販賣機點餐好再到外面排隊，等店員出來收你點餐的單子，千萬不要跟著人潮傻傻地排隊

來日本怎麼可以錯過在地拉麵店，這家位於京都車站附近，在Google評論上算是非常高的拉麵店🍜(2600多則評論還有4.4顆星，在日本算是寶藏名店了)，我看過不少網紅拍片介紹過，也許有不少人已經知道這間店，但我還是很想介紹給大家。還記得每次經過這條路都會看到大排長龍的人潮，第一次吃的時候是晚上8點多還排了1個多小時，但我必須說真的值得🥹 非常推薦這間的沾麵，湯頭是我在其他地方沒有喝過的，絕對不是什麼味噌、醬油、鹽味的口味，我覺得多了些海鮮的鮮味外，還帶點微微的辣但不會像日本拉麵給人既定印象是偏鹹要猛灌水，是那種會讓人忍不住一口接著一口的湯頭🤤 如果是食量比較大的人可以點麵加大或是另外加點一碗山椒飯，日幣1000多就可以吃很飽，也是一家高CP值的店，推薦給大家🙌🏻

⚠️小Tips：店內大概只有10個位子，只有在它營業前去排隊這個選項，不然基本上都是需要排隊的，除非你個人有不用排隊的體質，不然還是乖乖早點去卡位吧",https://www.google.com/maps/place/%E5%90%9F%E9%87%80%E6%8B%89%E9%BA%B5+%E4%B9%85%E4%BF%9D%E7%94%B0/data=!4m2!3m1!1s0x600108a13c7a2d5d:0x2c1acd85fdf5ca75,🤘 吃飯飯,
Kyoto Ramen Koji,各種拉麵都在這裡,https://www.google.com/maps/place/Kyoto+Ramen+Koji/data=!4m2!3m1!1s0x6001089a3a451a29:0x8aa203d50015c17c,🤘 吃飯飯,
Yukou,牡蠣，蛤蜊為基底,https://www.google.com/maps/place/Yukou/data=!4m2!3m1!1s0x6001094a10b57a45:0xf30619cc172bde60,🤘 吃飯飯,
Hanayori Kiyoe,湯葉豆皮奶油可樂餅,https://www.google.com/maps/place/Hanayori+Kiyoe/data=!4m2!3m1!1s0x600108941ddad50b:0x23e36cf9285ce04e,🤘 吃飯飯,
Arashiyama Curry,,https://www.google.com/maps/place/Arashiyama+Curry/data=!4m2!3m1!1s0x6001a9fc2a5eddab:0x1faaab96b6721a74,🤘 吃飯飯,
烤糰子 十文堂,,https://www.google.com/maps/place/%E7%83%A4%E7%B3%B0%E5%AD%90+%E5%8D%81%E6%96%87%E5%A0%82/data=!4m2!3m1!1s0x600108c5960e571d:0x5a1738a823cf587,🤘 吃飯飯,
Checkin 飯店 四條烏丸,,https://www.google.com/maps/place/Checkin+%E9%A3%AF%E5%BA%97+%E5%9B%9B%E6%A2%9D%E7%83%8F%E4%B8%B8/data=!4m2!3m1!1s0x6001089af1a3c3af:0xb203717b2742c744,🏨 家,
Kushikatsu Daruma - Shinsekai Main Shop,九十多年歷史炸串,https://www.google.com/maps/place/Kushikatsu+Daruma+-+Shinsekai+Main+Shop/data=!4m2!3m1!1s0x6000e76009075ee5:0xeed4bda269c8a677,🤘 吃飯飯,
Tokura Kyoto Sanjo,報資漢寶牌,https://www.google.com/maps/place/Tokura+Kyoto+Sanjo/data=!4m2!3m1!1s0x6001093841eddb13:0xe457df37e90ab058,🤘 吃飯飯,
“Ekimae” kaisendon restaurant,Cp值很高的海鮮懂飯,https://www.google.com/maps/place/%E2%80%9CEkimae%E2%80%9D+kaisendon+restaurant/data=!4m2!3m1!1s0x6000e692c74250ad:0x7ea913318f048dee,🤘 吃飯飯,
串炸 八重勝,,https://www.google.com/maps/place/%E4%B8%B2%E7%82%B8+%E5%85%AB%E9%87%8D%E5%8B%9D/data=!4m2!3m1!1s0x6000dd8ab619eebd:0x487dcc07ecb7e704,🤘 吃飯飯,
Maita-ya,"大阪市區某個商店街的章魚燒,

一顆3円而已,裡面都是日本人沒有觀光客,道 頓堀一份都要800~1000円。 
還有24小時無人的服飾店,1000円-5000円,大衣 跟皮衣都只要3000円,太香了。",https://www.google.com/maps/place/Maita-ya/data=!4m2!3m1!1s0x6000e1cb1e5ed825:0xb4d889f9021e6b64,🤘 吃飯飯,
串炸 天狗,人很多,https://www.google.com/maps/place/%E4%B8%B2%E7%82%B8+%E5%A4%A9%E7%8B%97/data=!4m2!3m1!1s0x6000dd8ab67eb929:0x48262d76de82d3c3,🤘 吃飯飯,
新世界 かんかん,大阪味的章魚燒 中間糊糊的,https://www.google.com/maps/place/%E6%96%B0%E4%B8%96%E7%95%8C+%E3%81%8B%E3%82%93%E3%81%8B%E3%82%93/data=!4m2!3m1!1s0x6000e7600482136d:0x547be728d93fd887,🤘 吃飯飯,
名代豬排,大推#大海老カツとヒレかつ(炸蝦&炸里脊套餐)、#濃口豬排醬+日式柚子醬,https://www.google.com/maps/place/%E5%90%8D%E4%BB%A3%E8%B1%AC%E6%8E%92/data=!4m2!3m1!1s0x600108924b00337d:0x1628dc527e3d4e0c,🤘 吃飯飯,
Kiyasu Sohonpo,,https://www.google.com/maps/place/Kiyasu+Sohonpo/data=!4m2!3m1!1s0x6000e68d76465acb:0x432401df57759f8a,🤘 吃飯飯,
Taishu Sukiyaki Hokuto GEMS Namba Branch,中午和牛1180,https://www.google.com/maps/place/Taishu+Sukiyaki+Hokuto+GEMS+Namba+Branch/data=!4m2!3m1!1s0x6000e78e88cf6963:0x13fe79ad645b20be,🤘 吃飯飯,
Takoyakiza,,https://www.google.com/maps/place/Takoyakiza/data=!4m2!3m1!1s0x6000e70c0c0c3a51:0xf691e66fccd99861,🤘 吃飯飯,
Achichi Honpo Dotonbori,,https://www.google.com/maps/place/Achichi+Honpo+Dotonbori/data=!4m2!3m1!1s0x6000e714f6c458d5:0x3e62c4440ae805e9,🤘 吃飯飯,
難波八阪神社,,https://www.google.com/maps/place/%E9%9B%A3%E6%B3%A2%E5%85%AB%E9%98%AA%E7%A5%9E%E7%A4%BE/data=!4m2!3m1!1s0x6000e77279bd5541:0x80c374197554ea9f,🎃 景點,
BATTEN YOKATO AMERIKAMURA,據說隨便點都不雷,https://www.google.com/maps/place/BATTEN+YOKATO+AMERIKAMURA/data=!4m2!3m1!1s0x6000e778508f87c3:0x12ff5ad43c5dbefd,🤘 吃飯飯,
Takoyaki Wanaka Sennichimae,,https://www.google.com/maps/place/Takoyaki+Wanaka+Sennichimae/data=!4m2!3m1!1s0x6000e76b07f5de63:0xc68f6cb004cb8af6,🤘 吃飯飯,
Sushi Ayase,午餐5500,https://www.google.com/maps/place/Sushi+Ayase/data=!4m2!3m1!1s0x6000e729f4eb569d:0x42f59d7b5a8f6734,🤘 吃飯飯,
春日大社,,https://www.google.com/maps/place/%E6%98%A5%E6%97%A5%E5%A4%A7%E7%A4%BE/data=!4m2!3m1!1s0x600139c06bb06ad5:0x4c97e78382e39596,🎃 景點,
Tōdai-ji,,https://www.google.com/maps/place/T%C5%8Ddai-ji/data=!4m2!3m1!1s0x600139907a0876dd:0xf890ac3f9dd53c8f,🎃 景點,
奈良公園,,https://www.google.com/maps/place/%E5%A5%88%E8%89%AF%E5%85%AC%E5%9C%92/data=!4m2!3m1!1s0x60013996bd8c6061:0xf96cacf357447456,🎃 景點,
宇治橋,,https://www.google.com/maps/place/%E5%AE%87%E6%B2%BB%E6%A9%8B/data=!4m2!3m1!1s0x6001110a5313ae9d:0x36bff55a841d0d8c,🎃 景點,
宇治上神社,,https://www.google.com/maps/place/%E5%AE%87%E6%B2%BB%E4%B8%8A%E7%A5%9E%E7%A4%BE/data=!4m2!3m1!1s0x60011173757af961:0x11600ef0d3975f5f,🎃 景點,
宇治神社 (兔子神社）,,https://www.google.com/maps/place/%E5%AE%87%E6%B2%BB%E7%A5%9E%E7%A4%BE+(%E5%85%94%E5%AD%90%E7%A5%9E%E7%A4%BE%EF%BC%89/data=!4m2!3m1!1s0x600111731014cfd9:0xe47629bd29c85f14,🎃 景點,
建仁寺,,https://www.google.com/maps/place/%E5%BB%BA%E4%BB%81%E5%AF%BA/data=!4m2!3m1!1s0x600108c1242b7b27:0x7e608f1986c5bb52,🎃 景點,
Kamo River,,https://www.google.com/maps/place/Kamo+River/data=!4m2!3m1!1s0x600108e457079b29:0x578668ecc6840c03,🎃 景點,
Nonkiya,燉牛筋，關東煮,https://www.google.com/maps/place/Nonkiya/data=!4m2!3m1!1s0x6000dd8aad775aa9:0x9389f475ae07f98c,🤘 吃飯飯,
Osaka Dojimahama Tower,免費看夜景的地方,https://www.google.com/maps/place/Osaka+Dojimahama+Tower/data=!4m2!3m1!1s0x6000e7002cc79d83:0x92846010eb670590,🎃 景點,
清水寺,,https://www.google.com/maps/place/%E6%B8%85%E6%B0%B4%E5%AF%BA/data=!4m2!3m1!1s0x600108d385dcfb07:0x62af658650c434ba,🎃 景點,
錦市場,,https://www.google.com/maps/place/%E9%8C%A6%E5%B8%82%E5%A0%B4/data=!4m2!3m1!1s0x6001089ccd8ccb4f:0xb69ea31001ec6c9c,🎃 景點,
伏見稻荷大社,,https://www.google.com/maps/place/%E4%BC%8F%E8%A6%8B%E7%A8%BB%E8%8D%B7%E5%A4%A7%E7%A4%BE/data=!4m2!3m1!1s0x60010f153d2e6d21:0x7b1aca1c753ae2e9,🎃 景點,
Sukiyaki Kimura,很道地的DIY壽喜燒,https://www.google.com/maps/place/Sukiyaki+Kimura/data=!4m2!3m1!1s0x60010894254122a3:0x84023cafa4c8c209,,
`;

			// === Weather ===
			// 填上你的 WeatherAPI key 可啟用即時天氣。
			const WEATHERAPI_KEY = ""; // TODO: "YOUR_KEY"
			const WEATHER_PROVIDER = WEATHERAPI_KEY ? "weatherapi" : "mock";

			const DAY_PRIMARY_CITY = {
				"4/16": "京都",
				"4/17": "京都",
				"4/18": "京都",
				"4/19": "京都",
				"4/20": "大阪",
				"4/21": "大阪",
				"4/22": "大阪",
			};

			const MOCK_WEATHER = {
				京都: {
					icon: "⛅️",
					hi: 22,
					lo: 13,
					rain: 25,
					text: "多雲時晴",
				},
				大阪: {
					icon: "🌤️",
					hi: 24,
					lo: 14,
					rain: 20,
					text: "晴到多雲",
				},
			};

			async function getWeatherForCity(city) {
				if (WEATHER_PROVIDER === "mock") {
					return { ...MOCK_WEATHER[city], source: "WeatherAPI（示意）" };
				}

				// WeatherAPI: current + forecast (簡化：用當天預報)
				// Docs: https://www.weatherapi.com/
				const endpoint = new URL("https://api.weatherapi.com/v1/forecast.json");
				endpoint.searchParams.set("key", WEATHERAPI_KEY);
				endpoint.searchParams.set("q", city);
				endpoint.searchParams.set("days", "1");
				endpoint.searchParams.set("lang", "zh");

				const res = await fetch(endpoint);
				if (!res.ok) throw new Error("WeatherAPI request failed");
				const data = await res.json();
				const day = data?.forecast?.forecastday?.[0]?.day;
				return {
					icon: "🌦️",
					hi: Math.round(day?.maxtemp_c ?? 0),
					lo: Math.round(day?.mintemp_c ?? 0),
					rain: Math.round(day?.daily_chance_of_rain ?? 0),
					text: day?.condition?.text ?? "-",
					source: "WeatherAPI",
				};
			}

			// === Stories / Tips (50-100字左右) ===
			const STORY = {
				"關西機場 (KIX)":
					"關西入境/出境的大門。落地後先確認入境動線與行李轉盤，建議提前準備 Visit Japan Web 以加快通關；機場內可買 ICOCA、SIM/eSIM、補充現金與零食，回程記得預留安檢與退稅時間。",
				"JR Haruka":
					"從關西機場直達京都最省心的特急之一。若已預約/購票，記得先到綠色機台或窗口兌換實體票與指定席；上車前看清楚月台與車廂號，行李可放置於座位後方或車廂端部空間。",
				"CheckIn Hotel 四條烏丸":
					"位在四條烏丸一帶，逛街與轉乘都方便。抵達後先確認入住時間與寄放行李規則，房內常見有加濕器/空氣清淨選項；周邊便利店密度高，晚上補給、隔天早起行程都好安排。",
				"伏見稻荷大社":
					"以千本鳥居聞名、供奉稻荷大神的稻荷信仰總本社，歷史可追溯到 8 世紀。紅色鳥居多由商家或個人奉納，象徵祈求生意興隆與五穀豐登；越往山上走越清幽，會遇到小神社與石狐狸。清晨最舒服、也最容易拍到乾淨的鳥居長廊。",
				"清水寺":
					"京都代表名剎之一，現存本堂多為江戶時代重建；著名的『清水舞台』以懸空木構架起，站在舞台邊能俯瞰京都街景。音羽之瀧三道泉水常被解讀為學業、戀愛、長壽等祈願，傳統說法是擇一取用更靈；寺域坡道與石階多，想慢慢逛、好好拍照，穿好走的鞋最重要。",
				"二年坂/三年坂":
					"清水寺門前延伸的傳統坡道街，石板路、町家與小店把『老京都』的氛圍拉滿。傳說三年坂跌倒不吉利（有人說會折壽、也有人說會帶來厄運），其實更多是提醒石板路雨天很滑要小心；想拍到更空的街景，建議一早來或傍晚收店前，光線也更柔和。",
				"錦市場":
					"被稱作『京都人的廚房』，狹長的市場街聚集海鮮、漬物、京野菜、豆皮與各式小吃，逛起來像一條可以吃的博物館。許多老店代代相傳，會看到職人把刀工、炭火與醃漬手藝當成日常；想慢慢試吃建議中午前到，傍晚店家會陸續收攤。部分路段不鼓勵邊走邊吃，看到告示就站到一旁吃完再走最禮貌。",
				"下鴨神社":
					"全名賀茂御祖神社，是京都最古老的神社群之一，也是世界遺產。入口的糺之森像城市裡的原始森林，走進去會立刻降溫、心情也慢下來；相傳能『糾正』心中的迷惘。主祭神與緣結、家族守護等信仰相關，授與品選擇多；參拜後到鴨川與高野川合流處散步，很有京都日常的味道。",
				"滿天串燒 (先斗町)":
					"先斗町小巷是京都夜晚的氣氛擔當，燈籠與木造街景很有味道。熱門店常需排隊或預約，建議提早到或先訂位；用餐後可沿鴨川散步，夜風偏涼可帶薄外套。",
				"JR 山陰本線":
					"前往嵐山一帶的常用鐵道路線，從京都/二條等站可銜接。通勤時段車廂較擠，想舒服可避開尖峰；IC 卡多半可直接刷進出，搭車前留意列車方向與停靠站別。",
				"嵐山小火車":
					"保津川沿線的觀光小火車，景色隨季節變化很有看頭。熱門班次建議事先訂票，座位通常面向河谷那側更好看；記得提前到站換票/取票，並預留排隊與拍照時間。",
				"御髮神社":
					"相傳是日本少見以『頭髮』為主題的神社，供奉與理髮業相關的祖師神，許多美容師與在意髮量的人會來祈願。境內小巧，常見奉納的梳子、髮相關御守很可愛；這一帶多是住宅小路，走訪時放低音量、不要堵住通行，會更像在京都散步。",
				"竹林小徑":
					"嵐山最經典的竹林步道，風吹竹葉的聲音很像天然白噪音。這裡之所以迷人，不只是『竹子很高』，而是光線穿透後形成的層次感：清晨或陰天反而更好拍。白天人潮多，拍照時靠邊、別停在路中央，既安全也更有禮貌。",
				"嵐山商業街":
					"嵐山車站周邊的商店街很適合邊走邊吃：可樂餅、抹茶甜點、伴手禮一次補齊。中午後人潮變多，餐廳候位時間會拉長；若要買限定商品，先逛再吃通常更有效率。",
				"宇治平等院":
					"以鳳凰堂聞名的世界遺產，也是 10 圓硬幣上的經典圖案。鳳凰堂建於平安時代末期，反映了當時貴族嚮往『極樂淨土』的審美：對稱的建築倒映在池面上，風一停就像一張明信片。想拍倒影建議開門就進園、避開團客尖峰；也別錯過館內文物（多為複製/展示與真品輪替），能更理解宇治在日本佛教文化裡的分量。",
				"中村藤吉 本店":
					"宇治代表級抹茶名店，甜點、茶飲與伴手禮都很強。通常需要現場抽號碼牌等候，建議一到就先取號再去附近散步；若不想久等，也可以改買外帶商品當作補給。",
				"奈良公園":
					"奈良的鹿被視為『神的使者』傳說已久，因此牠們在市區裡的存在感非常自然。鹿很親人也很會搶食：拿鹿仙貝時先把包裝收好、手伸直給餅，別一次掏出一大把；被圍住就快步移動到人少處。看到鹿鞠躬也別太驚訝，那常是『學會了討餅的動作』，不是禮貌競賽。",
				"若草山":
					"奈良市景的超好取景點，坡度不算難但一路上去會小喘。若草山也與奈良的『山燒』傳統活動有名（每年固定時節點火），山體因此常保持草坡的樣貌；傍晚時分光線會把城市染成金色，很適合慢慢走、慢慢拍。入場/關門時間要留意，想看晚霞建議提早上山卡位並注意天候與風。",
				"ZONE 心齋橋西區":
					"大阪市區住宿的落腳點，移動到心齋橋/本町一帶相對便利。Check-in 後先確認門禁、電梯與備品規則；晚上回飯店路上注意末班車時間，若有購物戰利品可先整理收納隔天更輕鬆。",
				"御堂筋線+公車":
					"前往勝尾寺常見的組合路線：地鐵先拉近距離，再轉乘公車上山。建議先查好公車班次與站牌位置，尖峰可能排隊；上車後留意下車提示，山區天氣較涼可帶薄外套。",
				"勝尾寺":
					"以『勝運』聞名的寺院，最吸睛的是到處都是奉納的小達摩：階梯邊、庭園角落、欄杆上都像在偷偷看著你。傳說把願望託付給達摩、完成後再回來還願，因此達摩會一年比一年多；越早到越好拍，也更能安靜感受山寺氣氛。山上偏涼，帶件薄外套會更舒服。",
				"箕面大瀑布":
					"大阪近郊的森林散步路線，步道沿溪走、空氣清新，很適合在市區行程中安排半日放鬆。路面多為平緩但偶有濕滑，鞋子要防滑；途中可補給小吃，楓葉天婦羅是人氣名物。",
				"心齋橋/道頓堀":
					"大阪最熱鬧的逛街與美食集中地：藥妝、服飾、招牌霓虹一次滿足。晚上人潮密度高，集合點建議先講好；想拍固力果跑跑人建議避開尖峰時段，逛街也別忘了留意末班車。",
				"大阪城天守閣":
					"大阪的城市象徵，最早由豐臣秀吉所建（後來多次戰火焚毀與重建），如今的天守閣外觀延續歷史意象。城郭規模很大，護城河與巨石城牆是看點之一；館內以展覽動線為主，登高能俯瞰大阪市區。想省排隊，建議一開門就先上樓、再慢慢往下看展。",
				"黑門市場":
					"大阪的『吃貨市場』，海鮮、生蠔、和牛、甜點應有盡有，從早餐一路吃到早午餐完全沒問題。這裡的節奏很大阪：豪爽、直接、香味四溢；熱門攤位常要排隊，越早來越能吃得從容。現金/電子支付規則各店不同，準備些零錢會更順。",
				"難波八阪神社":
					"以巨大『獅子殿』聞名的神社，張口的造型被說能『吞掉厄運、帶來勝運』，因此考生與想轉運的人特別愛來。腹地不大、停留時間短，很適合排在道頓堀/心齋橋逛街前後當作小插曲；拍照時別擋住參拜動線，退一步會更好取景也更有禮貌。",
				"梅田空中庭園":
					"位於梅田的高樓展望台，以連結兩棟大樓的露天圓形迴廊最有辨識度。這裡的浪漫點在於『視野很開』：日落時看天色從藍到金，再一路切到夜景，是同一個位置收兩種風景。高空風大偏涼，尤其夜間建議帶薄外套；想避排隊就提早到，先上去卡黃昏時段最划算。",
				"難波 Parco/大丸":
					"最後一天的補貨與伴手禮衝刺點，百貨與商場品牌齊全，逛起來不怕雨。建議先鎖定要買的樓層與品牌，集中採買省時間；若要退稅，記得帶護照並把收據與商品包裝保留好。",
				"臨空城 Outlet":
					"機場前最後一站的大型 Outlet，時間抓得好很適合做『最後補一波』。熱門運動品牌與精品折扣常有驚喜，但也容易買到超重；建議先確認行李重量與托運規則，並預留移動到機場的時間。",
				"南海電鐵":
					"從大阪市區往返關西機場的重要路線之一，班次多、路線清楚。出發前先確認要搭普通/特急與停靠站別，避免上錯車；若時間緊迫建議提早到站，並把登機所需文件集中收納方便拿取。",
			};

			// === CSV parser (supports quoted fields) ===
			function parseCSV(csv) {
				const rows = [];
				let current = [];
				let value = "";
				let inQuotes = false;

				for (let i = 0; i < csv.length; i++) {
					const ch = csv[i];
					const next = csv[i + 1];

					if (ch === '"') {
						if (inQuotes && next === '"') {
							value += '"';
							i++;
							continue;
						}
						inQuotes = !inQuotes;
						continue;
					}

					if (!inQuotes && ch === ",") {
						current.push(value);
						value = "";
						continue;
					}

					if (!inQuotes && (ch === "\n" || ch === "\r")) {
						if (ch === "\r" && next === "\n") i++;
						current.push(value);
						value = "";
						if (current.some((cell) => cell.trim() !== "")) rows.push(current);
						current = [];
						continue;
					}

					value += ch;
				}

				if (value.length > 0 || current.length > 0) {
					current.push(value);
					if (current.some((cell) => cell.trim() !== "")) rows.push(current);
				}

				const headers = rows.shift().map((h) => h.trim());
				return rows.map((r) => {
					const obj = {};
					headers.forEach((h, idx) => {
						obj[h] = (r[idx] ?? "").trim();
					});
					return obj;
				});
			}

			function parseMonthDay(md) {
				const [m, d] = md.split("/").map((x) => Number(x));
				// 2026
				return new Date(2026, m - 1, d);
			}

			function weekdayShort(date) {
				return new Intl.DateTimeFormat("zh-TW", { weekday: "short" }).format(date);
			}

			function formatDayTitle(md, dayIndex) {
				const dt = parseMonthDay(md);
				return `${md} (${weekdayShort(dt)}) | Day ${dayIndex}`;
			}

			function normalizeType(type) {
				const t = type.trim();
				if (t === "景點") return { cls: "sight", label: "📍 景點" };
				if (t === "餐廳") return { cls: "food", label: "🍴 餐廳" };
				if (t === "交通") return { cls: "transit", label: "🚆 交通" };
				if (t === "住宿") return { cls: "stay", label: "🏨 住宿" };
				if (t === "購物") return { cls: "shop", label: "🛍️ 購物" };
				return { cls: "other", label: `• ${t || "其他"}` };
			}

			function escapeHtml(s) {
				return String(s)
					.replaceAll("&", "&amp;")
					.replaceAll("<", "&lt;")
					.replaceAll(">", "&gt;")
					.replaceAll('"', "&quot;");
			}

			function normalizeFoodTag(raw) {
				const t = String(raw || "").trim();
				if (t.includes("🏨")) return { key: "stay", cls: "stay", label: "🏨 住宿" };
				if (t.includes("🤘") || t.includes("吃飯飯")) return { key: "food", cls: "food", label: "🍴 吃飯飯" };
				if (t.includes("🎃") || t.includes("景點")) return { key: "sight", cls: "sight", label: "📍 景點" };
				return { key: "other", cls: "other", label: "• 其他" };
			}

			function normalizeFoodItem(obj) {
				const title = String(obj["標題"] || "").trim();
				const note = String(obj["筆記"] || "").trim();
				const url = String(obj["網址"] || "").trim();
				const tagRaw = String(obj["標籤"] || "").trim();
				const comment = String(obj["留言"] || "").trim();
				return { title, note, url, tagRaw, comment };
			}

			const FOOD_PLACES = ["京都", "大阪", "宇治", "奈良"];
			const FOOD_PLACE_KEY = "kansai_food_place_v1";
			let FOOD_PLACE_SELECTED = "京都";

			function inferFoodPlace(it) {
				const text = `${it.title || ""} ${it.note || ""} ${it.url || ""}`.toLowerCase();
				if (text.includes("宇治") || text.includes("uji")) return "宇治";
				if (
					text.includes("奈良") ||
					text.includes("nara") ||
					text.includes("春日") ||
					text.includes("東大寺") ||
					text.includes("todai") ||
					text.includes("tōdai")
				)
					return "奈良";
				if (
					text.includes("大阪") ||
					text.includes("osaka") ||
					text.includes("難波") ||
					text.includes("namba") ||
					text.includes("心齋橋") ||
					text.includes("shinsaibashi") ||
					text.includes("道頓堀") ||
					text.includes("dotonbori") ||
					text.includes("新世界") ||
					text.includes("shinsekai") ||
					text.includes("梅田") ||
					text.includes("umeda") ||
					text.includes("amerikamura")
				)
					return "大阪";
				if (
					text.includes("京都") ||
					text.includes("kyoto") ||
					text.includes("嵐山") ||
					text.includes("arashiyama") ||
					text.includes("四條") ||
					text.includes("shijo") ||
					text.includes("清水") ||
					text.includes("伏見") ||
					text.includes("錦")
				)
					return "京都";
				return "京都";
			}

			function loadFoodPlaceDefault() {
				const saved = localStorage.getItem(FOOD_PLACE_KEY);
				if (saved && FOOD_PLACES.includes(saved)) return saved;
				return "京都";
			}

			function setFoodPlace(place) {
				if (!FOOD_PLACES.includes(place)) return;
				FOOD_PLACE_SELECTED = place;
				localStorage.setItem(FOOD_PLACE_KEY, place);
				renderFoodPlaceTabs(place);
				renderFood(FOOD_ITEMS_CACHE, place);
			}

			function renderFoodPlaceTabs(selectedPlace) {
				const tabs = document.getElementById("foodPlaceTabs");
				if (!tabs) return;
				tabs.innerHTML = "";
				FOOD_PLACES.forEach((place) => {
					const btn = document.createElement("button");
					btn.type = "button";
					btn.className = "day-tab";
					btn.setAttribute("role", "tab");
					btn.setAttribute("data-place", place);
					btn.setAttribute("aria-selected", place === selectedPlace ? "true" : "false");
					btn.textContent = `📍${place}`;
					btn.addEventListener("click", () => setFoodPlace(place));
					tabs.appendChild(btn);
				});
			}

			function dedupeFoodItems(items) {
				const byKey = new Map();
				for (const it of items) {
					const titleKey = it.title
						.normalize("NFKC")
						.replaceAll(/[\s\u3000]+/g, " ")
						.trim()
						.toLowerCase();
					const urlKey = (it.url || "").trim().toLowerCase();
					const key = titleKey || urlKey;
					if (!key) continue;
					const normalized = { ...it, _key: key };

					if (!byKey.has(key)) {
						byKey.set(key, normalized);
						continue;
					}

					const prev = byKey.get(key);
					// Merge: keep the most informative fields.
					prev.url = prev.url || normalized.url;
					prev.tagRaw = prev.tagRaw || normalized.tagRaw;
					prev.comment = prev.comment || normalized.comment;
					if ((normalized.note || "").length > (prev.note || "").length) prev.note = normalized.note;
					byKey.set(key, prev);
				}
				return Array.from(byKey.values());
			}

			const FOOD_PINNED_KEY = "kansai_food_pinned_v1";
			let FOOD_PINNED_CACHE = {};
			const FOOD_PINNED_ORDER_KEY = "kansai_food_pinned_order_v1";
			let FOOD_PINNED_ORDER_CACHE = {};

			function loadFoodPinned() {
				try {
					const raw = localStorage.getItem(FOOD_PINNED_KEY);
					if (!raw) return {};
					const parsed = JSON.parse(raw);
					return parsed && typeof parsed === "object" ? parsed : {};
				} catch {
					return {};
				}
			}

			function saveFoodPinned(pinned) {
				localStorage.setItem(FOOD_PINNED_KEY, JSON.stringify(pinned || {}));
			}

			function loadFoodPinnedOrder() {
				try {
					const raw = localStorage.getItem(FOOD_PINNED_ORDER_KEY);
					if (!raw) return {};
					const parsed = JSON.parse(raw);
					return parsed && typeof parsed === "object" ? parsed : {};
				} catch {
					return {};
				}
			}

			function saveFoodPinnedOrder(orderByPlace) {
				localStorage.setItem(FOOD_PINNED_ORDER_KEY, JSON.stringify(orderByPlace || {}));
			}

			function getPinnedOrderForPlace(place) {
				const arr = FOOD_PINNED_ORDER_CACHE?.[place];
				return Array.isArray(arr) ? arr.filter((x) => typeof x === "string") : [];
			}

			function setPinnedOrderForPlace(place, order) {
				if (!FOOD_PLACES.includes(place)) return;
				FOOD_PINNED_ORDER_CACHE[place] = (order || []).filter((x) => typeof x === "string");
				saveFoodPinnedOrder(FOOD_PINNED_ORDER_CACHE);
			}

			function isFoodPinned(key) {
				return !!(key && FOOD_PINNED_CACHE && FOOD_PINNED_CACHE[key]);
			}

			function toggleFoodPinned(key) {
				if (!key) return;
				if (isFoodPinned(key)) delete FOOD_PINNED_CACHE[key];
				else FOOD_PINNED_CACHE[key] = true;
				saveFoodPinned(FOOD_PINNED_CACHE);
			}

			function wireFoodPinned() {
				const root = document.getElementById("foodRoot");
				if (!root) return;
				root.addEventListener("click", (e) => {
					const btn = e.target.closest("button[data-pin]");
					if (!btn) return;
					const key = btn.getAttribute("data-pin") || "";
					toggleFoodPinned(key);
					renderFood(FOOD_ITEMS_CACHE, FOOD_PLACE_SELECTED);
				});
			}

			function wirePinnedSort() {
				const root = document.getElementById("foodRoot");
				if (!root) return;

				let draggingKey = "";
				let touchDraggingEl = null;
				let touchPlace = "";

				const getPinnedList = () => document.getElementById("foodPinnedList");
				const saveOrderFromDom = (place) => {
					const list = getPinnedList();
					if (!list) return;
					const keys = Array.from(list.querySelectorAll(".card[data-pin-key]"))
						.map((el) => el.getAttribute("data-pin-key") || "")
						.filter(Boolean);
					setPinnedOrderForPlace(place, keys);
				};

				const reorderByPointer = (list, draggedEl, overEl, clientY) => {
					if (!list || !draggedEl || !overEl || draggedEl === overEl) return;
					const r = overEl.getBoundingClientRect();
					const before = clientY < r.top + r.height / 2;
					list.insertBefore(draggedEl, before ? overEl : overEl.nextSibling);
				};

				// Mouse / Desktop drag & drop
				root.addEventListener("dragstart", (e) => {
					const card = e.target.closest(".card[data-pin-key]");
					const list = getPinnedList();
					if (!card || !list || !list.contains(card)) return;
					draggingKey = card.getAttribute("data-pin-key") || "";
					card.classList.add("dragging");
					e.dataTransfer?.setData("text/plain", draggingKey);
					e.dataTransfer && (e.dataTransfer.effectAllowed = "move");
				});

				root.addEventListener("dragend", (e) => {
					const card = e.target.closest(".card[data-pin-key]");
					if (card) card.classList.remove("dragging");
					draggingKey = "";
				});

				root.addEventListener("dragover", (e) => {
					const list = getPinnedList();
					if (!list) return;
					const overEl = e.target.closest(".card[data-pin-key]");
					const draggedEl = list.querySelector(`.card[data-pin-key="${CSS.escape(draggingKey)}"]`);
					if (!overEl || !draggedEl || !list.contains(overEl)) return;
					e.preventDefault();
					reorderByPointer(list, draggedEl, overEl, e.clientY);
				});

				root.addEventListener("drop", (e) => {
					const list = getPinnedList();
					if (!list) return;
					e.preventDefault();
					const place = list.getAttribute("data-place") || FOOD_PLACE_SELECTED;
					saveOrderFromDom(place);
				});

				// Touch drag (mobile)
				root.addEventListener(
					"touchstart",
					(e) => {
						const list = getPinnedList();
						if (!list) return;
						const card = e.target.closest(".card[data-pin-key]");
						if (!card || !list.contains(card)) return;
						touchDraggingEl = card;
						touchPlace = list.getAttribute("data-place") || FOOD_PLACE_SELECTED;
						card.classList.add("dragging");
					},
					{ passive: true }
				);

				root.addEventListener(
					"touchmove",
					(e) => {
						const list = getPinnedList();
						if (!list || !touchDraggingEl) return;
						const t = e.touches?.[0];
						if (!t) return;
						e.preventDefault();
						const el = document.elementFromPoint(t.clientX, t.clientY);
						const overEl = el?.closest?.(".card[data-pin-key]") || null;
						if (!overEl || !list.contains(overEl)) return;
						reorderByPointer(list, touchDraggingEl, overEl, t.clientY);
					},
					{ passive: false }
				);

				root.addEventListener(
					"touchend",
					() => {
						if (touchDraggingEl) touchDraggingEl.classList.remove("dragging");
						if (touchPlace) saveOrderFromDom(touchPlace);
						touchDraggingEl = null;
						touchPlace = "";
					},
					{ passive: true }
				);
			}

			const FOOD_NOTES_KEY = "kansai_food_notes_v1";
			let FOOD_NOTES_CACHE = {};

			function loadFoodNotes() {
				try {
					const raw = localStorage.getItem(FOOD_NOTES_KEY);
					if (!raw) return {};
					const parsed = JSON.parse(raw);
					return parsed && typeof parsed === "object" ? parsed : {};
				} catch {
					return {};
				}
			}

			function saveFoodNotes(notes) {
				localStorage.setItem(FOOD_NOTES_KEY, JSON.stringify(notes || {}));
			}

			function getFoodNote(key) {
				if (!key) return "";
				const v = FOOD_NOTES_CACHE[key];
				return typeof v === "string" ? v : "";
			}

			function setFoodNote(key, value) {
				if (!key) return;
				const v = String(value || "");
				if (!v.trim()) {
					delete FOOD_NOTES_CACHE[key];
				} else {
					FOOD_NOTES_CACHE[key] = v;
				}
				saveFoodNotes(FOOD_NOTES_CACHE);
			}

			function wireFoodNotes() {
				const root = document.getElementById("foodRoot");
				if (!root) return;

				const timers = new Map();
				const saveSoon = (key, value) => {
					if (timers.has(key)) clearTimeout(timers.get(key));
					timers.set(
						key,
						setTimeout(() => {
							setFoodNote(key, value);
						}, 250)
					);
				};

				root.addEventListener("input", (e) => {
					const ta = e.target.closest("textarea.note-input");
					if (!ta) return;
					const key = ta.getAttribute("data-food-note") || "";
					saveSoon(key, ta.value);
				});

				root.addEventListener("blur", (e) => {
					const ta = e.target.closest("textarea.note-input");
					if (!ta) return;
					const key = ta.getAttribute("data-food-note") || "";
					setFoodNote(key, ta.value);
				}, true);
			}

			let FOOD_ITEMS_CACHE = [];

			function renderFood(foodItems, selectedPlace) {
				const root = document.getElementById("foodRoot");
				if (!root) return;
				const place = FOOD_PLACES.includes(selectedPlace) ? selectedPlace : "京都";
				const filtered = (foodItems || []).filter((x) => x.place === place);
				const pinnedOrder = getPinnedOrderForPlace(place);
				const pinnedItems = filtered.filter((x) => isFoodPinned(x._key)).slice();
				const pinnedIndex = new Map(pinnedOrder.map((k, i) => [k, i]));
				pinnedItems.sort((a, b) => {
					const ai = pinnedIndex.has(a._key) ? pinnedIndex.get(a._key) : 1e9;
					const bi = pinnedIndex.has(b._key) ? pinnedIndex.get(b._key) : 1e9;
					if (ai !== bi) return ai - bi;
					return (a.title || "").localeCompare(b.title || "");
				});
				const unpinnedItems = filtered
					.filter((x) => !isFoodPinned(x._key))
					.slice();

				const groupsOrder = ["food", "stay", "sight", "other"];
				const groups = new Map();
				for (const it of unpinnedItems) {
					const tag = normalizeFoodTag(it.tagRaw);
					if (!groups.has(tag.key)) groups.set(tag.key, []);
					groups.get(tag.key).push({ ...it, tag });
				}
				for (const arr of groups.values()) {
					arr.sort((a, b) => (a.title || "").localeCompare(b.title || ""));
				}

				const total = filtered.length;
				root.innerHTML = `
					<div class="hint-note">已整理 ${escapeHtml(
						String(total)
					)} 筆收藏（${escapeHtml(`📍${place}`)}）。筆記可直接編輯並自動保存；按「⭐ 置頂」會出現在本頁最上方。</div>
					<div class="tool-grid">
						${
							pinnedItems.length
								? `
									<section class="tool-card">
										<div class="section-title">⭐ 置頂（${escapeHtml(
											String(pinnedItems.length)
										)}）<span class="hint-note" style="margin-left:8px;">（可拖曳調整順序）</span></div>
										<div class="items" id="foodPinnedList" data-place="${escapeHtml(place)}">
											${pinnedItems
												.map((it) => {
													const safeTitle = escapeHtml(it.title || "-");
													const map = it.url || mapUrl(it.title, "");
													const note = getFoodNote(it._key) || it.note || "";
													const comment = it.comment || "";
													const noteSummary = note.trim() ? "（可編輯，自動保存）" : "（可編輯）";
													const placeBadge = `📍${it.place || place}`;
													return `
														<article class="card" draggable="true" data-pin-key="${escapeHtml(
															it._key
														)}">
															<div class="card-top">
																<div>
																	<div class="time">${escapeHtml(placeBadge)}｜置頂</div>
																	<div class="name">${safeTitle}</div>
																</div>
																<div class="tag ${escapeHtml(
																	normalizeFoodTag(it.tagRaw).cls
																)}">${escapeHtml(normalizeFoodTag(it.tagRaw).label)}</div>
															</div>

														<div class="card-body">
															${
																comment
																	? `<div class="row"><div class="k">留言</div><div class="v">${escapeHtml(
																		comment
																	)}</div></div>`
																	: ""
															}

															<details class="story">
																<summary>筆記 <span class="hint">${escapeHtml(noteSummary)}</span></summary>
																<textarea class="note-input" data-food-note="${escapeHtml(
																	titleKeyOrUrl(it)
																)}" placeholder="在這裡補充筆記…">${escapeHtml(
																	note
																)}</textarea>
															</details>

															<div class="actions">
																<button class="btn" type="button" data-pin="${escapeHtml(
																	it._key
																)}">⭐ 已置頂</button>
																<a class="btn primary" href="${escapeHtml(
																	map
																)}" target="_blank" rel="noopener noreferrer">🗺️ 地圖</a>
															</div>
														</div>
													</article>
												`;
											})
												.join("")}
										</div>
									</section>
								`
								: ""
						}
						${groupsOrder
							.filter((k) => (groups.get(k) || []).length > 0)
							.map((k) => {
								const arr = groups.get(k) || [];
								const anyTag = arr[0]?.tag || normalizeFoodTag(k);
								return `
									<section class="tool-card">
										<div class="section-title">${escapeHtml(anyTag.label)}（${escapeHtml(
											String(arr.length)
										)}）</div>
										<div class="items">
											${arr
												.map((it) => {
													const safeTitle = escapeHtml(it.title || "-");
													const map = it.url || mapUrl(it.title, "");
													const note = getFoodNote(it._key) || it.note || "";
													const comment = it.comment || "";
													const noteSummary = note.trim() ? "（可編輯，自動保存）" : "（可編輯）";
														const placeBadge = `📍${it.place || place}`;
														const pinned = isFoodPinned(it._key);
													return `
														<article class="card">
															<div class="card-top">
																<div>
																		<div class="time">${escapeHtml(placeBadge)}｜收藏</div>
																	<div class="name">${safeTitle}</div>
																</div>
																<div class="tag ${escapeHtml(it.tag.cls)}">${escapeHtml(it.tag.label)}</div>
														</div>

														<div class="card-body">
															${
																comment
																	? `<div class="row"><div class="k">留言</div><div class="v">${escapeHtml(
																		comment
																	)}</div></div>`
																	: ""
															}

															<details class="story">
																<summary>筆記 <span class="hint">${escapeHtml(noteSummary)}</span></summary>
																<textarea class="note-input" data-food-note="${escapeHtml(
																	titleKeyOrUrl(it)
																)}" placeholder="在這裡補充筆記…">${escapeHtml(
																	note
																)}</textarea>
															</details>

															<div class="actions">
																<button class="btn" type="button" data-pin="${escapeHtml(
																	it._key
																)}">${pinned ? "⭐ 已置頂" : "☆ 置頂"}</button>
																<a class="btn primary" href="${escapeHtml(map)}" target="_blank" rel="noopener noreferrer">🗺️ 地圖</a>
															</div>
														</div>
													</article>
												`;
											})
												.join("")}
										</div>
									</section>
								`;
							})
							.join("")}
					</div>
				`;
			}

			function titleKeyOrUrl(it) {
				return it?._key || "";
			}

			function extractGuidePills(note) {
				const pills = [];
				const re = /【(必吃|必點|必買|預約)】([^【】]+)/g;
				let m;
				while ((m = re.exec(note)) !== null) {
					const kind = m[1];
					const raw = (m[2] || "").trim();
					const main = raw.split(/；|，|。|\(|\)|\s{2,}/)[0].trim();
					if (!main) continue;
					if (kind === "必吃") pills.push({ cls: "must-eat", text: `必吃：${main}` });
					if (kind === "必點") pills.push({ cls: "must-order", text: `必點：${main}` });
					if (kind === "必買") pills.push({ cls: "must-buy", text: `必買：${main}` });
					if (kind === "預約") pills.push({ cls: "reserve", text: `預約：${main}` });
				}
				return pills;
			}

			function mapUrl(name, address) {
				const q = [name, address].filter(Boolean).join(" ");
				const url = new URL("https://www.google.com/maps/search/");
				url.searchParams.set("api", "1");
				url.searchParams.set("query", q);
				return url.toString();
			}

			const SELECTED_DAY_KEY = "kansai_selected_day_v1";
			let DAYS_CACHE = [];
			let CURRENT_PAGE = "daily";

			function getDefaultSelectedDay(days) {
				const saved = localStorage.getItem(SELECTED_DAY_KEY);
				if (saved && days.some((d) => d.md === saved)) return saved;
				return days[0]?.md || "";
			}

			function renderDayTabs(days, selectedMd) {
				const tabs = document.getElementById("dayTabs");
				tabs.innerHTML = "";

				days.forEach((day) => {
					const btn = document.createElement("button");
					btn.type = "button";
					btn.className = "day-tab";
					btn.setAttribute("role", "tab");
					btn.setAttribute("data-md", day.md);
					btn.setAttribute("aria-selected", day.md === selectedMd ? "true" : "false");
					btn.textContent = `${day.md}｜Day ${day.dayIndex}`;
					btn.addEventListener("click", () => setSelectedDay(day.md));
					tabs.appendChild(btn);
				});
			}

			function applySelectedDayToUI(selectedMd) {
				document.querySelectorAll("#dailyRoot .day").forEach((dayEl) => {
					dayEl.style.display = dayEl.getAttribute("data-md") === selectedMd ? "block" : "none";
				});

				document.querySelectorAll("#dayTabs .day-tab").forEach((tab) => {
					tab.setAttribute(
						"aria-selected",
						tab.getAttribute("data-md") === selectedMd ? "true" : "false"
					);
				});

				const active = Array.from(document.querySelectorAll("#dayTabs .day-tab")).find(
					(x) => x.getAttribute("data-md") === selectedMd
				);
				active?.scrollIntoView?.({ behavior: "smooth", inline: "center", block: "nearest" });
				window.scrollTo({ top: 0, behavior: "smooth" });
			}

			function setSelectedDay(md) {
				if (!md || !DAYS_CACHE.some((d) => d.md === md)) return;
				localStorage.setItem(SELECTED_DAY_KEY, md);
				applySelectedDayToUI(md);
				if (CURRENT_PAGE === "map") queueMapRefresh();
			}

			function getSelectedDayMd() {
				const saved = localStorage.getItem(SELECTED_DAY_KEY);
				if (saved && DAYS_CACHE.some((d) => d.md === saved)) return saved;
				return DAYS_CACHE[0]?.md || "";
			}

			function getSelectedDayObj() {
				const md = getSelectedDayMd();
				return DAYS_CACHE.find((d) => d.md === md) || DAYS_CACHE[0] || null;
			}

			// === Map (Leaflet) ===
			const MAP_SHOW_CITY_FOOD_KEY = "kansai_map_show_city_food_v1";
			const GEOCODE_CACHE_KEY = "kansai_geocode_cache_v1";
			const GEOCODE_TTL_MS = 1000 * 60 * 60 * 24 * 30; // 30 days
			const NOMINATIM_ENDPOINT = "https://nominatim.openstreetmap.org/search";
			const CITY_CENTER = {
				京都: [35.0116, 135.7681],
				大阪: [34.6937, 135.5023],
				宇治: [34.8843, 135.7991],
				奈良: [34.6851, 135.8048],
			};

			let mapInstance = null;
			let mapDayLayer = null;
			let mapFoodLayer = null;
			let mapUserMarker = null;
			let mapUserLocation = null;
			let mapGeoWatchId = null;
			let mapShowCityFood = localStorage.getItem(MAP_SHOW_CITY_FOOD_KEY) === "1";
			let mapRefreshTimer = null;

			function setMapLoading(isLoading) {
				const el = document.getElementById("mapLoading");
				if (!el) return;
				el.setAttribute("aria-hidden", isLoading ? "false" : "true");
			}

			function loadGeocodeCache() {
				try {
					return JSON.parse(localStorage.getItem(GEOCODE_CACHE_KEY) || "{}") || {};
				} catch {
					return {};
				}
			}

			function saveGeocodeCache(cache) {
				try {
					localStorage.setItem(GEOCODE_CACHE_KEY, JSON.stringify(cache));
				} catch {
					// ignore quota
				}
			}

			let geocodeQueue = Promise.resolve();
			function scheduleGeocode(fn) {
				// Serialize + tiny delay to be gentle with Nominatim
				geocodeQueue = geocodeQueue
					.then(() => fn())
					.then(
						(res) =>
							new Promise((resolve) => {
								setTimeout(() => resolve(res), 220);
							})
					);
				return geocodeQueue;
			}

			async function geocodeOne(query) {
				const q = String(query || "").trim();
				if (!q) return null;
				const key = q.toLowerCase();
				const cache = loadGeocodeCache();
				const hit = cache[key];
				if (hit && hit.lat && hit.lng && Date.now() - (hit.ts || 0) < GEOCODE_TTL_MS) {
					return { lat: hit.lat, lng: hit.lng, name: hit.name || q };
				}

				return scheduleGeocode(async () => {
					const url = new URL(NOMINATIM_ENDPOINT);
					url.searchParams.set("format", "json");
					url.searchParams.set("q", q);
					url.searchParams.set("limit", "1");
					const res = await fetch(url.toString(), {
						headers: {
							"Accept": "application/json",
							"Accept-Language": "ja,zh-TW,zh,en",
						},
					});
					if (!res.ok) return null;
					const data = await res.json();
					const row = Array.isArray(data) ? data[0] : null;
					if (!row) return null;
					const lat = Number.parseFloat(row.lat);
					const lng = Number.parseFloat(row.lon);
					if (!Number.isFinite(lat) || !Number.isFinite(lng)) return null;
					cache[key] = { lat, lng, name: row.display_name || q, ts: Date.now() };
					saveGeocodeCache(cache);
					return { lat, lng, name: row.display_name || q };
				});
			}

			function resizeMapShell() {
				const shell = document.getElementById("mapShell");
				if (!shell) return;
				const topbar = document.querySelector(".topbar");
				const tabs = document.querySelector(".tabs");
				const top = topbar ? topbar.getBoundingClientRect().bottom : 0;
				const bottom = tabs ? tabs.getBoundingClientRect().height : 84;
				const target = Math.max(280, Math.floor(window.innerHeight - top - bottom - 16));
				shell.style.height = `${target}px`;
				if (mapInstance) mapInstance.invalidateSize();
			}

			function startUserLocationWatch() {
				if (!("geolocation" in navigator)) return;
				if (mapGeoWatchId !== null) return;
				mapGeoWatchId = navigator.geolocation.watchPosition(
					(pos) => {
						mapUserLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
						if (!mapInstance) return;
						const icon = L.divIcon({
							className: "",
							html: "<div class='gps-pulse'></div>",
							iconSize: [14, 14],
						});
						if (mapUserMarker) mapUserMarker.setLatLng([mapUserLocation.lat, mapUserLocation.lng]);
						else mapUserMarker = L.marker([mapUserLocation.lat, mapUserLocation.lng], { icon }).addTo(mapInstance);
					},
					() => {
						// ignore
					},
					{ enableHighAccuracy: true, maximumAge: 15000, timeout: 10000 }
				);
			}

			function stopUserLocationWatch() {
				if (!("geolocation" in navigator)) return;
				if (mapGeoWatchId === null) return;
				navigator.geolocation.clearWatch(mapGeoWatchId);
				mapGeoWatchId = null;
			}

			function centerOnUser() {
				if (!mapInstance || !mapUserLocation) return;
				mapInstance.flyTo([mapUserLocation.lat, mapUserLocation.lng], 15, { duration: 0.75 });
			}

			function updateMapToggleButton() {
				const btn = document.getElementById("mapToggleFood");
				if (!btn) return;
				btn.textContent = mapShowCityFood ? "✓ 今日餐廳" : "＋今日餐廳";
				btn.classList.toggle("primary", !mapShowCityFood);
			}

			function ensureMapInstance() {
				if (mapInstance) return;
				const mapEl = document.getElementById("map");
				if (!mapEl || typeof L === "undefined") return;
				const day = getSelectedDayObj();
				const city = day?.city || "京都";
				const center = CITY_CENTER[city] || CITY_CENTER["京都"];
				mapInstance = L.map("map", { zoomControl: true }).setView(center, 13);
				L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
					attribution: "© OpenStreetMap",
					maxZoom: 19,
				}).addTo(mapInstance);
				mapDayLayer = L.layerGroup().addTo(mapInstance);
				mapFoodLayer = L.layerGroup().addTo(mapInstance);
			}

			function getDayLocationQueries(day) {
				const out = [];
				const seen = new Set();
				for (const it of day?.items || []) {
					const name = String(it["名稱"] || "").trim();
					const addr = String(it["地址/地點"] || "").trim();
					const type = String(it["類型"] || "").trim();
					if (!name && !addr) continue;
					const q = [name, addr].filter(Boolean).join(" ");
					const key = q.toLowerCase();
					if (seen.has(key)) continue;
					seen.add(key);
					out.push({ q, name, addr, type });
				}
				return out;
			}

			function getCityFoodItems(city) {
				const list = Array.isArray(FOOD_ITEMS_CACHE) ? FOOD_ITEMS_CACHE : [];
				return list
					.filter((it) => it.place === city)
					.filter((it) => normalizeFoodTag(it.tagRaw).key === "food");
			}

			async function refreshMapLayers() {
				ensureMapInstance();
				if (!mapInstance || !mapDayLayer || !mapFoodLayer) return;
				resizeMapShell();
				updateMapToggleButton();

				const day = getSelectedDayObj();
				const city = day?.city || "京都";
				const title = document.getElementById("mapTitle");
				if (title) title.textContent = `🗺️ ${city}｜${day?.md || ""}`;

				setMapLoading(true);
				mapDayLayer.clearLayers();
				mapFoodLayer.clearLayers();

				const bounds = L.latLngBounds();
				let points = 0;
				let foodPoints = 0;
				let hasBounds = false;

				// Day points
				const dayQueries = getDayLocationQueries(day);
				for (const row of dayQueries) {
					const hit = await geocodeOne(row.q);
					if (!hit) continue;
					const dot = L.circleMarker([hit.lat, hit.lng], {
						radius: 7,
						color: "rgba(47, 79, 79, 0.95)",
						weight: 2,
						fillColor: "rgba(47, 79, 79, 0.35)",
						fillOpacity: 0.9,
					});
					const link = mapUrl(row.name, row.addr);
					dot.bindPopup(
						`<div style="font-weight:900;margin-bottom:6px;">${escapeHtml(row.name || row.addr || row.q)}</div>` +
							(row.addr ? `<div style="font-size:12px;opacity:.75;">${escapeHtml(row.addr)}</div>` : "") +
							`<div style="margin-top:10px;"><a href="${escapeHtml(link)}" target="_blank" rel="noopener noreferrer">🧭 導航</a></div>`
					);
					dot.addTo(mapDayLayer);
					bounds.extend([hit.lat, hit.lng]);
					hasBounds = true;
					points++;
				}

				// City food overlay
				if (mapShowCityFood) {
					const foods = getCityFoodItems(city);
					for (const it of foods) {
						const q = `${it.title || ""} ${city}`.trim();
						const hit = await geocodeOne(q);
						if (!hit) continue;
						const dot = L.circleMarker([hit.lat, hit.lng], {
							radius: 7,
							color: "rgba(255, 107, 107, 0.95)",
							weight: 2,
							fillColor: "rgba(255, 107, 107, 0.35)",
							fillOpacity: 0.9,
						});
						const link = it.url || mapUrl(it.title, city);
						dot.bindPopup(
							`<div style="font-weight:950;margin-bottom:6px;">🍴 ${escapeHtml(it.title || "餐廳")}</div>` +
								(it.note ? `<div style="font-size:12px;opacity:.78;">${escapeHtml(it.note)}</div>` : "") +
								`<div style="margin-top:10px;"><a href="${escapeHtml(link)}" target="_blank" rel="noopener noreferrer">🧭 打開地圖</a></div>`
						);
						dot.addTo(mapFoodLayer);
						bounds.extend([hit.lat, hit.lng]);
						hasBounds = true;
						foodPoints++;
					}
				}

				// Counts
				const counts = document.getElementById("mapCounts");
				if (counts) {
					const base = `當天 ${points} 點`;
					const plus = mapShowCityFood ? `｜餐廳 ${foodPoints} 間` : "";
					counts.textContent = base + plus;
				}

				// Fit bounds (prefer POIs; else fallback center)
				if (hasBounds) {
					mapInstance.fitBounds(bounds, { padding: [40, 40] });
				} else {
					const center = CITY_CENTER[city] || CITY_CENTER["京都"];
					mapInstance.setView(center, 13);
				}
				points = points;
				setMapLoading(false);
			}

			function queueMapRefresh() {
				if (mapRefreshTimer) window.clearTimeout(mapRefreshTimer);
				mapRefreshTimer = window.setTimeout(() => {
					if (CURRENT_PAGE === "map") refreshMapLayers();
				}, 80);
			}

			function renderDaily(days, selectedMd) {
				const root = document.getElementById("dailyRoot");
				root.innerHTML = "";

					days.forEach((day) => {
					const weatherId = `wx-${day.md.replace("/", "-")}`;
					const header = document.createElement("div");
					header.className = "day-header";
					header.innerHTML = `
						<div class="day-title">
							<div class="left">
								<div class="date">${escapeHtml(formatDayTitle(day.md, day.dayIndex))}</div>
								<div class="meta">主要地點：${escapeHtml(day.city)}｜${escapeHtml(day.summary)}</div>
							</div>
							<div class="weather" id="${weatherId}">
								<div class="wx-icon" aria-hidden="true">…</div>
								<div class="wx-text">
									<div class="t">讀取天氣中</div>
									<div class="d">請稍候</div>
									<div class="wx-source">來源：-</div>
								</div>
							</div>
						</div>
					`;

					const itemsWrap = document.createElement("div");
					itemsWrap.className = "items";

					day.items.forEach((it) => {
						const type = normalizeType(it["類型"]);
						const note = it["備註/攻略"] || "";
						const pills = extractGuidePills(note);
						const address = it["地址/地點"] && it["地址/地點"] !== "-" ? it["地址/地點"] : "";
						const fee = it["費用"] && it["費用"] !== "-" ? it["費用"] : "-";
						const story = STORY[it["名稱"]] || "";

						const card = document.createElement("article");
						card.className = "card";
						card.innerHTML = `
							<div class="card-top">
								<span class="tag ${type.cls}">${escapeHtml(type.label)}</span>
								<span class="time">${escapeHtml(it["時間"])}</span>
							</div>
							<div class="card-body">
								<div class="name">${escapeHtml(it["名稱"])}</div>
								<div class="row"><div class="k">內容</div><div class="v">${escapeHtml(it["詳細資訊"])}</div></div>
								<div class="row"><div class="k">費用</div><div class="v">${escapeHtml(fee)}</div></div>
								<div class="row"><div class="k">地點</div><div class="v">${escapeHtml(address || "（以名稱導航）")}</div></div>
								${
									pills.length
										? `<div class="guide">${pills
												.map(
													(p) =>
														`<span class="pill ${p.cls}">${escapeHtml(p.text)}</span>`
												)
												.join("")}</div>`
										: ""
								}
								${
									story
										? `<details class="story"><summary>小故事 / 小貼士<span class="hint">點我展開</span></summary><p>${escapeHtml(
												story
											)}</p></details>`
										: ""
								}
								<div class="actions">
									<a class="btn primary" href="${escapeHtml(
										mapUrl(it["名稱"], address)
									)}" target="_blank" rel="noopener">🧭 導航</a>
								</div>
								${
									note && note !== "-"
										? `<div class="row"><div class="k">備註</div><div class="v">${escapeHtml(
												note
											)}</div></div>`
										: ""
								}
							</div>
						`;
						itemsWrap.appendChild(card);
					});

						const dayWrap = document.createElement("section");
						dayWrap.className = "day";
						dayWrap.setAttribute("data-md", day.md);
						dayWrap.style.display = day.md === selectedMd ? "block" : "none";
					dayWrap.appendChild(header);
					dayWrap.appendChild(itemsWrap);
					root.appendChild(dayWrap);

					// Weather async
					getWeatherForCity(day.city)
						.then((wx) => {
							const el = document.getElementById(weatherId);
							if (!el) return;
							el.innerHTML = `
								<div class="wx-icon" aria-hidden="true">${escapeHtml(wx.icon)}</div>
								<div class="wx-text">
									<div class="t">${escapeHtml(day.city)}｜${escapeHtml(wx.text)}</div>
									<div class="d">${escapeHtml(String(wx.lo))}°C – ${escapeHtml(
								String(wx.hi)
							)}°C｜降雨 ${escapeHtml(String(wx.rain))}%</div>
									<div class="wx-source">來源：${escapeHtml(wx.source)}</div>
								</div>
							`;
						})
						.catch(() => {
							const el = document.getElementById(weatherId);
							if (!el) return;
							el.innerHTML = `
								<div class="wx-icon" aria-hidden="true">⚠️</div>
								<div class="wx-text">
									<div class="t">天氣載入失敗</div>
									<div class="d">請稍後再試</div>
									<div class="wx-source">來源：WeatherAPI</div>
								</div>
							`;
						});
				});
			}

			// === Tools page ===
			const TOOLBOX = {
				flights: {
					out: {
						flightNo: "D7378",
						airline: "AirAsia X",
						from: "桃園 (TPE)",
						to: "關西 (KIX)",
						dep: "4/16 15:40",
						arr: "4/16 19:20",
						terminalGate: "以當日公告為準",
					},
					back: {
						flightNo: "D7379",
						airline: "AirAsia X",
						from: "關西 (KIX)",
						to: "桃園 (TPE)",
						dep: "4/22 20:55",
						arr: "4/22 22:55",
						terminalGate: "KIX 第一航廈（T1）B7（筆記）｜其餘以當日公告為準",
					},
				},
				hotels: [
					{
						name: "CheckIn Hotel 四條烏丸",
						address: "京都市中京区手洗水町654-2",
						stay: "4/16 → 4/19（3晚）",
						checkin: "14:00 後",
						checkout: "11:00 前",
						note: "地鐵 21 號出口步行約 2 分鐘；1F 有 Lawson",
					},
					{
						name: "ZONE 心齋橋西區",
						address: "大阪市西区立売堀1-10-2",
						stay: "4/19 → 4/22（3晚）",
						checkin: "以訂房確認為準",
						checkout: "以訂房確認為準",
						note: "本町站/心齋橋站步行可達",
					},
				],
				emergency: {
					jp: [
						{ label: "警察", value: "110" },
						{ label: "救護車/消防", value: "119" },
					],
					placeholders: [
						{ label: "台灣駐日辦事處（請填）", value: "—" },
						{ label: "信用卡海外掛失（請填）", value: "—" },
					],
				},
				budget: {
					paid: [
						{ name: "機票", amountTwd: 6396 },
						{ name: "大阪住宿", amountTwd: 1818 },
						{ name: "京都住宿", amountTwd: 2863 },
					],
				},
			};

			const LEDGER_KEY = "kansai_ledger_v1";
			const HOTEL_BOOKING_KEY = "kansai_hotel_booking_v1";

			function loadHotelBooking() {
				try {
					const raw = localStorage.getItem(HOTEL_BOOKING_KEY);
					if (!raw) return {};
					const parsed = JSON.parse(raw);
					return parsed && typeof parsed === "object" ? parsed : {};
				} catch {
					return {};
				}
			}

			function saveHotelBooking(state) {
				localStorage.setItem(HOTEL_BOOKING_KEY, JSON.stringify(state || {}));
			}

			function loadLedger() {
				try {
					const raw = localStorage.getItem(LEDGER_KEY);
					if (!raw) return [];
					const parsed = JSON.parse(raw);
					return Array.isArray(parsed) ? parsed : [];
				} catch {
					return [];
				}
			}

			function saveLedger(rows) {
				localStorage.setItem(LEDGER_KEY, JSON.stringify(rows));
			}

			function sumBudgetTwd() {
				return TOOLBOX.budget.paid.reduce((a, b) => a + (b.amountTwd || 0), 0);
			}

			function money(n) {
				return new Intl.NumberFormat("zh-TW").format(n);
			}

			function renderTools(ledgerRows) {
				const root = document.getElementById("toolsRoot");
				const f = TOOLBOX.flights;
				const hotels = TOOLBOX.hotels;
				const hotelBooking = loadHotelBooking();
				const emergency = TOOLBOX.emergency;
				const budget = TOOLBOX.budget;

				root.innerHTML = `
					<section class="tool-card">
						<div class="section-title">✈️ 航班資訊</div>
						<div class="kv">
							<div class="line"><div class="k">去程</div><div class="v">${escapeHtml(
								`${f.out.airline} ${f.out.flightNo}`
							)}</div></div>
							<div class="line"><div class="k">時間</div><div class="v">${escapeHtml(
								`${f.out.dep} → ${f.out.arr}`
							)}</div></div>
							<div class="line"><div class="k">航線</div><div class="v">${escapeHtml(
								`${f.out.from} → ${f.out.to}`
							)}</div></div>
							<div class="line"><div class="k">航廈/登機門</div><div class="v">${escapeHtml(
								f.out.terminalGate
							)}</div></div>
							<div class="line"><div class="k">回程</div><div class="v">${escapeHtml(
								`${f.back.airline} ${f.back.flightNo}`
							)}</div></div>
							<div class="line"><div class="k">時間</div><div class="v">${escapeHtml(
								`${f.back.dep} → ${f.back.arr}`
							)}</div></div>
							<div class="line"><div class="k">航線</div><div class="v">${escapeHtml(
								`${f.back.from} → ${f.back.to}`
							)}</div></div>
							<div class="line"><div class="k">航廈/登機門</div><div class="v">${escapeHtml(
								f.back.terminalGate
							)}</div></div>
						</div>
						<div class="small">建議回程至少提前 3 小時到機場辦理登機。</div>
					</section>

					<section class="tool-card">
						<div class="section-title">🏨 住宿資訊</div>
						${hotels
							.map((h, idx) => {
								const b = (hotelBooking && hotelBooking[idx]) || {};
								const orderNo = typeof b.orderNo === "string" ? b.orderNo : "";
								const pin = typeof b.pin === "string" ? b.pin : "";
								return `
									<div class="hotel-box" data-hotel-box="${idx}">
										<div class="hotel-name">${escapeHtml(h.name)}</div>
										<div class="hotel-stay">住宿期間：${escapeHtml(h.stay || "")}</div>
										<div class="kv">
											<div class="line"><div class="k">地址</div><div class="v">${escapeHtml(
												h.address
											)}</div></div>
											<div class="line"><div class="k">Check-in</div><div class="v">${escapeHtml(
												h.checkin
											)}</div></div>
											<div class="line"><div class="k">Check-out</div><div class="v">${escapeHtml(
												h.checkout
											)}</div></div>
											<div class="line"><div class="k">備註</div><div class="v">${escapeHtml(
												h.note
											)}</div></div>
										</div>
										<div class="hotel-fields">
											<label>
												訂單編號
												<input type="text" autocomplete="off" placeholder="自行填寫" data-hotel-idx="${idx}" data-hotel-field="orderNo" value="${escapeHtml(
													orderNo
												)}" />
											</label>
											<label>
												PIN碼
												<input type="text" autocomplete="off" placeholder="自行填寫" data-hotel-idx="${idx}" data-hotel-field="pin" value="${escapeHtml(
													pin
												)}" />
											</label>
										</div>
									</div>
								`;
							})
							.join("")}
					</section>

					<section class="tool-card">
						<div class="section-title">📞 緊急聯絡</div>
						<div class="kv">
							${emergency.jp
								.map(
									(x) =>
										`<div class="line"><div class="k">${escapeHtml(
											x.label
										)}</div><div class="v">${escapeHtml(x.value)}</div></div>`
								)
								.join("")}
							${emergency.placeholders
								.map(
									(x) =>
										`<div class="line"><div class="k">${escapeHtml(
											x.label
										)}</div><div class="v">${escapeHtml(x.value)}</div></div>`
								)
								.join("")}
						</div>
						<div class="small">提示：可把常用電話改成自己的版本（直接改本檔案）。</div>
					</section>

					<section class="tool-card">
						<div class="section-title">💰 預算與記帳表</div>
						<div class="kv">
							${budget.paid
								.map(
									(x) =>
										`<div class="line"><div class="k">已付：${escapeHtml(
											x.name
										)}</div><div class="v">TWD ${escapeHtml(
											money(x.amountTwd)
										)}</div></div>`
								)
								.join("")}
							<div class="line"><div class="k">合計</div><div class="v">TWD ${escapeHtml(
								money(sumBudgetTwd())
							)}</div></div>
						</div>

						<div class="ledger">
							<form id="ledgerForm" autocomplete="off">
								<label>
									日期
									<input name="date" type="date" required />
								</label>
								<label>
									類別
									<select name="category" required>
										<option value="交通">交通</option>
										<option value="餐飲">餐飲</option>
										<option value="景點">景點</option>
										<option value="購物">購物</option>
										<option value="住宿">住宿</option>
										<option value="其他" selected>其他</option>
									</select>
								</label>
								<label class="full">
									項目
									<input name="item" type="text" placeholder="例：黑門市場 生蠔" required />
								</label>
								<label>
									幣別
									<select name="currency" required>
										<option value="JPY" selected>JPY（日圓）</option>
										<option value="TWD">TWD（台幣）</option>
									</select>
								</label>
								<label>
									金額
									<input name="amount" type="number" inputmode="decimal" min="0" step="0.01" required />
								</label>
								<div class="full" style="display:flex; gap:10px;">
									<button class="btn primary" type="submit" style="flex:1;">➕ 新增</button>
									<button class="btn danger" id="ledgerClear" type="button" style="flex:1;">清除全部</button>
								</div>
							</form>

							<div id="ledgerSummary"></div>
							<div style="overflow:auto;">
								<table class="table" aria-label="記帳表">
									<thead>
										<tr>
											<th>日期</th>
											<th>類別</th>
											<th>項目</th>
											<th class="right">金額</th>
											<th></th>
										</tr>
									</thead>
									<tbody id="ledgerBody"></tbody>
								</table>
							</div>
						</div>

						<div class="small">記帳資料會儲存在本機瀏覽器（localStorage），不會上傳。</div>
					</section>
				`;

				wireHotelBooking();
				wireLedger(ledgerRows);
			}

			function wireHotelBooking() {
				const state = loadHotelBooking();
				const inputs = document.querySelectorAll("[data-hotel-idx][data-hotel-field]");
				inputs.forEach((input) => {
					input.addEventListener("input", () => {
						const idx = String(input.getAttribute("data-hotel-idx") || "");
						const field = String(input.getAttribute("data-hotel-field") || "");
						if (!idx) return;
						if (field !== "orderNo" && field !== "pin") return;
						state[idx] = state[idx] && typeof state[idx] === "object" ? state[idx] : {};
						state[idx][field] = String(input.value || "");
						saveHotelBooking(state);
					});
				});
			}

			function computeLedgerSummary(rows) {
				const byCurrency = new Map();
				const byCatCurrency = new Map();
				for (const r of rows) {
					const amount = Number(r.amount || 0);
					const cur = r.currency || "JPY";
					const cat = r.category || "其他";

					byCurrency.set(cur, (byCurrency.get(cur) || 0) + amount);
					const key = `${cat}__${cur}`;
					byCatCurrency.set(key, (byCatCurrency.get(key) || 0) + amount);
				}
				return { byCurrency, byCatCurrency };
			}

			function renderLedgerTable(rows) {
				const body = document.getElementById("ledgerBody");
				body.innerHTML = "";

				rows
					.slice()
					.sort((a, b) => (a.date || "").localeCompare(b.date || ""))
					.forEach((r, idx) => {
						const tr = document.createElement("tr");
						tr.innerHTML = `
							<td>${escapeHtml(r.date || "-")}</td>
							<td>${escapeHtml(r.category || "-")}</td>
							<td>${escapeHtml(r.item || "-")}</td>
							<td class="right">${escapeHtml(r.currency || "")}&nbsp;${escapeHtml(
								money(Number(r.amount || 0))
							)}</td>
							<td class="right"><button class="btn danger" data-del="${escapeHtml(
								String(idx)
							)}" type="button">刪除</button></td>
						`;
						body.appendChild(tr);
					});
			}

			function renderLedgerSummary(rows) {
				const el = document.getElementById("ledgerSummary");
				const { byCurrency, byCatCurrency } = computeLedgerSummary(rows);

				const currencies = Array.from(byCurrency.keys()).sort();
				const totalsLine = currencies
					.map((c) => `${c} ${money(byCurrency.get(c) || 0)}`)
					.join("｜");

				const cats = ["交通", "餐飲", "景點", "購物", "住宿", "其他"];
				const breakdown = cats
					.map((cat) => {
						const parts = currencies
							.map((cur) => {
								const v = byCatCurrency.get(`${cat}__${cur}`) || 0;
								return v ? `${cur} ${money(v)}` : null;
							})
							.filter(Boolean)
							.join(" / ");
						if (!parts) return null;
						return `<div class="line"><div class="k">${escapeHtml(
							cat
						)}</div><div class="v">${escapeHtml(parts)}</div></div>`;
					})
					.filter(Boolean)
					.join("");

				el.innerHTML = `
					<div class="kv" style="margin-top:0;">
						<div class="line"><div class="k">總支出</div><div class="v">${escapeHtml(
							totalsLine || "-"
						)}</div></div>
						${breakdown}
					</div>
				`;
			}

			function wireLedger(initialRows) {
				let rows = initialRows.slice();

				const form = document.getElementById("ledgerForm");
				const clearBtn = document.getElementById("ledgerClear");
				const body = document.getElementById("ledgerBody");

				const rerender = () => {
					saveLedger(rows);
					renderLedgerSummary(rows);
					renderLedgerTable(rows);
				};

				rerender();

				form.addEventListener("submit", (e) => {
					e.preventDefault();
					const fd = new FormData(form);
					const row = {
						date: String(fd.get("date") || "").trim(),
						category: String(fd.get("category") || "其他").trim(),
						item: String(fd.get("item") || "").trim(),
						currency: String(fd.get("currency") || "JPY").trim(),
						amount: Number(fd.get("amount") || 0),
					};

					if (!row.date || !row.item || !(row.amount >= 0)) return;
					rows.push(row);
					form.reset();
					rerender();
				});

				clearBtn.addEventListener("click", () => {
					const ok = confirm("確定清除全部記帳資料？（此動作無法復原）");
					if (!ok) return;
					rows = [];
					rerender();
				});

				body.addEventListener("click", (e) => {
					const btn = e.target.closest("button[data-del]");
					if (!btn) return;
					const idx = Number(btn.getAttribute("data-del"));
					if (!Number.isFinite(idx)) return;
					rows.splice(idx, 1);
					rerender();
				});
			}

			// === App init ===
			function buildDays(items) {
				const byDate = new Map();
				for (const it of items) {
					const md = it["日期"];
					if (!byDate.has(md)) byDate.set(md, []);
					byDate.get(md).push(it);
				}
				const dates = Array.from(byDate.keys()).sort((a, b) => {
					const da = parseMonthDay(a);
					const db = parseMonthDay(b);
					return da - db;
				});
				return dates.map((md, i) => {
					const city = DAY_PRIMARY_CITY[md] || "京都";
					const dayIndex = i + 1;
					const its = byDate.get(md).slice().sort((a, b) => (a["時間"] || "").localeCompare(b["時間"] || ""));
					const summary = `${its.length} 個行程`;
					return { md, city, dayIndex, items: its, summary };
				});
			}

			function setPage(page) {
				CURRENT_PAGE = page;
				const isDaily = page === "daily";
				const isMap = page === "map";
				const isFood = page === "food";
				const isTools = page === "tools";
				document.getElementById("page-daily").setAttribute("aria-hidden", isDaily ? "false" : "true");
				document.getElementById("page-map").setAttribute("aria-hidden", isMap ? "false" : "true");
				document.getElementById("page-food").setAttribute("aria-hidden", isFood ? "false" : "true");
				document.getElementById("page-tools").setAttribute("aria-hidden", isTools ? "false" : "true");
				document.getElementById("tab-daily").setAttribute("aria-selected", isDaily ? "true" : "false");
				document.getElementById("tab-map").setAttribute("aria-selected", isMap ? "true" : "false");
				document.getElementById("tab-food").setAttribute("aria-selected", isFood ? "true" : "false");
				document.getElementById("tab-tools").setAttribute("aria-selected", isTools ? "true" : "false");

				if (isMap) {
					startUserLocationWatch();
					queueMapRefresh();
					resizeMapShell();
					setTimeout(() => mapInstance?.invalidateSize?.(), 120);
				} else {
					stopUserLocationWatch();
				}
			}

			function init() {
				const now = new Date();
				document.getElementById("nowHint").textContent = `今天：${now.toLocaleDateString("zh-TW")}`;

				const items = parseCSV(ITINERARY_CSV);
				const days = buildDays(items);
				DAYS_CACHE = days;
				const selected = getDefaultSelectedDay(days);
				renderDayTabs(days, selected);
				renderDaily(days, selected);

				FOOD_NOTES_CACHE = loadFoodNotes();
				FOOD_PINNED_CACHE = loadFoodPinned();
				FOOD_PINNED_ORDER_CACHE = loadFoodPinnedOrder();
				const foodRaw = parseCSV(FOOD_CSV)
					.map(normalizeFoodItem)
					.filter((x) => (x.title || x.url) && x.title !== "—");
				const foodItems = dedupeFoodItems(foodRaw).map((x) => ({ ...x, place: inferFoodPlace(x) }));
				FOOD_ITEMS_CACHE = foodItems;
				FOOD_PLACE_SELECTED = loadFoodPlaceDefault();
				renderFoodPlaceTabs(FOOD_PLACE_SELECTED);
				renderFood(foodItems, FOOD_PLACE_SELECTED);
				wireFoodNotes();
				wireFoodPinned();
				wirePinnedSort();

				const ledgerRows = loadLedger();
				renderTools(ledgerRows);

				document.getElementById("tab-daily").addEventListener("click", () => setPage("daily"));
				document.getElementById("tab-map").addEventListener("click", () => setPage("map"));
				document.getElementById("tab-food").addEventListener("click", () => setPage("food"));
				document.getElementById("tab-tools").addEventListener("click", () => setPage("tools"));

				// Map controls
				updateMapToggleButton();
				document.getElementById("mapRefresh")?.addEventListener("click", () => refreshMapLayers());
				document.getElementById("mapLocate")?.addEventListener("click", () => centerOnUser());
				document.getElementById("mapToggleFood")?.addEventListener("click", () => {
					mapShowCityFood = !mapShowCityFood;
					localStorage.setItem(MAP_SHOW_CITY_FOOD_KEY, mapShowCityFood ? "1" : "0");
					refreshMapLayers();
				});
				window.addEventListener("resize", () => {
					if (CURRENT_PAGE === "map") resizeMapShell();
				});
			}

			init();
		</script>
	</body>
</html>
kyoto.html
目前顯示的是「kyoto.html」。 
